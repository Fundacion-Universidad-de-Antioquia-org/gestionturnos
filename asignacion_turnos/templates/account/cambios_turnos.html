{% extends 'base.html'%}
{% load static %}


{% block styles %}

<!--Estilos par el boton comentarios-->
<style>
  .btn-icon {
    border: 0;
    background: transparent;
    cursor: pointer;
    padding: 4px 6px;
  }

  .btn-icon .material-symbols-outlined {
    font-size: 20px;
    color: #1D5031;
  }

  .btn-icon:hover .material-symbols-outlined {
    opacity: .8;
  }
</style>

{% endblock %}

{% block content %}
<section class="usuario-bar-section">
<div class="usuario-bar d-flex align-items-center justify-content-between px-3">

<!-- Sección Izquierda: Foto + Usuario -->
<div class="usuario-bar-logo-nombre">
    <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
  <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- Título de la página -->
    <div class="saludo" style="color: #5a9138; font-size: 11px;">Cambios de turnos</div>
  </div>
  <div class="usuario-bar-centro">
    <button title="Refrescar página" onclick="refrescarPagina()" ><span class="material-symbols-outlined">refresh</span></button>
  </div>
 
  </div>

</div>
</section>

<!-- Acordeón de filtros -->
 <section class="acordion-section" id="accordionHeader">
<div class="accordion-container" style="margin-top: 14px;">
  <div class="accordion-header"><span class="material-symbols-outlined">search</span>Filtros de Búsqueda</div>
  <div class="accordion-body">
    <div class="filtros-horizontal">
      <div class="filtro-item">
        <label for="filtroNombre">Nombre:</label>
        <input type="text" id="filtroNombre" placeholder="Buscar por nombre">
      </div>
      <div class="filtro-item">
        <label for="filtroCodigo">Código:</label>
        <input type="text" id="filtroCodigo" placeholder="Buscar por código">
      </div>
      <div class="filtro-item">
        <label for="filtroTurno">Turno:</label>
        <input type="text" id="filtroTurno" placeholder="Buscar por turno">
      </div>
      <div class="filtro-item">
        <label for="filtroCargo">Cargo:</label>
        <select name="select" id="filtroCargo">
          <option value="">Todos</option>
          <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO">CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO</option>
          <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA">CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA</option>
          <option value="OPERADOR(A) DE CONDUCCION">OPERADOR(A) DE CONDUCCION</option>
          <option value="MANIOBRISTA TRENES">MANIOBRISTA TRENES</option>
          <option value="MANIOBRISTA TRANVIA">MANIOBRISTA TRANVIA</option>
          <option value="INCONSISTENCIA">INCONSISTENCIA</option>
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Estado de solicitud:</label>
        <select name="" id="filtroEstadoSolicitud">
          <option value="todos">todos</option>
          <option value="pendiente" selected>pendiente</option>
          <option value="aprobado">aprobado</option>
          <option value="desaprobado">desaprobado</option>
        </select>
      </div>
    </div>
  </div>
</div>
</section>

</div>
</section>

<!--Tabla de datos-->
<section class="table-section">
  <table class="table styled-table display" id="tablaDatos">
    <thead>
      <tr>
        <th>Solicitante</th>
        <th>Código</th>
        <th>Cargo</th>
        <th>Turno Original</th>
        <th>Turno Deseado</th>
        <th>Fecha de cambio</th>
        <th>Receptor</th>
        <th>Código</th>
        <th>Cargo</th>  
        <th>Turno Original</th>
        <th>Turno Deseado</th>
        <th>Estado EMP</th>
        <th>Estado ADM</th>
        <th>Sistema</th>
        <th>Check</th>
      </tr>
    </thead>
    <tbody id="tablaBody">
      {% for data in resultadosCambiosTurnos %}
      <tr>
        <td>{{ data.nombre_solicitante }}</td>
        <td class="codigoSolicitante">{{ data.codigo_solicitante }} <br><br>
          <span style="border-radius: 8px; background-color: #efad21; padding: 4px;">{{ data.formacion_solicitante }}</span><br><br>
          {% if data.zonaSolicitante %}
          <span>{{ data.zonaSolicitante }}</span>
          {% else %}
          <span>NO TRANSPORTABLE</span> 
          {% endif %}
        </td>
        <td>{{ data.cargo_solicitante }}</td>
        <td>{{ data.turno_solicitante_original }}</td>
        <td class="turnoSolicitanteDiaDeseado">{{ data.turno_solicitante_nuevo}}</td>
        <td class="fechaCambio">{{ data.fecha_solicitud_cambio|date:"d/m/Y" }}</td>
        <td>{{ data.nombre_receptor }}</td>
        <td class="codigoReceptor">{{ data.codigo_receptor }} <br> <br>
          <span style="border-radius: 8px; background-color: #efad21; padding: 4px;">{{ data.formacion_receptor }}</span><br><br>
          {% if data.zonaReceptor %}
          <span>{{ data.zonaReceptor }}</span>  
          {% else %}
          <span>NO TRANSPORTABLE</span> 
          {% endif %}
        </td>
        <td>{{ data.cargo_receptor }} </td>
        <td>{{ data.turno_receptor_original }}</td>
        <td class="turnoReceptorDiaDeseado">{{ data.turno_receptor_nuevo }}</td>
        <td class="aprobadoEmp">{{ data.estado_cambio_emp }}</td>
        <td class="aprobadoAdm">{{ data.estado_cambio_admin }}</td>
        <td>{% if data.comentarios %}
          <button type="button" class="btn-icon ver-msg" data-title="Sistema"
            data-msg="{{ data.comentarios|escapejs }}" aria-label="Ver comentarios">
            <span class="material-symbols-outlined" style="color: #2d6fe9; font-size: 35px;">info</span>
          </button>
          {% else %}
          -
          {% endif %}

        </td>
        <td class="checkbox-cell"><input type="checkbox" class="checkbox-item" style="justify-items: center;"></td>

      </tr>
      {% empty %}
      <tr>
        <td colspan="12">No hay solicitudes de cambio por ahora</td>
      </tr>

      {% endfor %}
    </tbody>
  </table>
  

</section>

<section class="panelControl-cambiosTurnos">  
<div class="acciones-finales">
  <button id="aprobarCambios" class="btn-aprobar">Aprobar cambios</button>
  <button class="btn-eliminar" id="desaprobarCambios">Rechazar solicitudes </button>
</div>
</section>
{% endblock %}
{% block scripts %}
<!-- Scripts boton seleccionar todos los elementos de la tabla-->
<script>
  document.getElementById("seleccionarTodos").addEventListener('click', function () {
    const checkboxes = document.querySelectorAll('.checkbox-item');
    const filas = Array.from(checkboxes).map(cb => cb.closest('tr'));

    const soloPendientes = filas.filter(fila =>
      fila.querySelector('.aprobadoAdm')?.textContent.trim().toLowerCase() === "desaprobado"
    );

    const allChecked = soloPendientes.every(fila => fila.querySelector('.checkbox-item').checked);

    soloPendientes.forEach(fila => {
      const cb = fila.querySelector('.checkbox-item');
      cb.checked = !allChecked;
    });

    this.textContent = allChecked ? 'Seleccionar todos' : 'Deseleccionar todos';
  });

</script>

<!--Scripts DOM-->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    aplicarFiltros();

  })

  function refrescarPagina(){
    window.location.reload()
  }
</script>

<!--Script boton aprobar cambios de turnos-->
<script>
  document.getElementById("aprobarCambios").addEventListener("click", function () {

    const datos = [];
    const checkboxesSeleccionados = document.querySelectorAll('.checkbox-item:checked');

    if (checkboxesSeleccionados.length === 0) {
      Swal.fire({
        icon: "warning",
        title: "Ningún cambio seleccionado",
        text: "Por favor, selecciona al menos un cambio de turno para aprobar o desaprobar.",
      });
      return;
    }

    checkboxesSeleccionados.forEach(checkbox => {
      const fila = checkbox.closest('tr');

      const estadoAdmin = fila.querySelector('.aprobadoAdm')?.textContent.trim().toLowerCase();
      const estadoEmp = fila.querySelector('.aprobadoEmp')?.textContent.trim().toLocaleLowerCase();

      if (estadoAdmin === "pendiente" && estadoEmp === "aprobado") {

        alert("entro al if")
        const codigoSoliSinFormato = fila.querySelector('.codigoSolicitante')?.textContent.trim();
        const codigoSolicitante = codigoSoliSinFormato.replace(/\D/g, "");
        const turnoSolicitanteDiaDeseado = fila.querySelector('.turnoSolicitanteDiaDeseado')?.textContent.trim();

        const codigoReceSinFormato = fila.querySelector('.codigoReceptor')?.textContent.trim();
        const codigoReceptor = codigoReceSinFormato.replace(/\D/g, "");
        const turnoReceptorDiaDeseado = fila.querySelector('.turnoReceptorDiaDeseado')?.textContent.trim();

        const fechaCambioTexto = fila.querySelector('.fechaCambio')?.textContent.trim();
        const fechaCambio = /^\d{2}\/\d{2}\/\d{4}$/.test(fechaCambioTexto)
          ? (() => {
            const [d, m, y] = fechaCambioTexto.split('/');
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
          })(): fechaCambioTexto;
          const peticion = "admin";

          alert(`codigoSolicitante: ${codigoSolicitante}, codigoReceptor: ${codigoReceptor}, fechaCmabio: ${fechaCambio}, peticion:${peticion}`)

        datos.push({
          fechaCambio,
          codigoSolicitante,
          codigoReceptor,
          turnoSolicitanteDiaDeseado,
          turnoReceptorDiaDeseado,
          peticion
        });

        fetch("{% url 'aprobar_solicitudes_cambios_turnos' %}", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ solicitudes: datos })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error("Error en la aprobación");
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              Swal.fire({
                title: "Se aprobo correctamente el cambio",
                text: data.message,
                icon: "success"
              })
                .then(() => {
                  location.reload();
                })

            } else {
              Swal.fire({
                icon: "error",
                title: "No se pudieron aprobar los cambios",
                text: data.message || "Ocurrió un error inesperado",
              });
            }
          })
          .catch(error => {
            console.error("Error en fetch:", error);
            Swal.fire({
              icon: "error",
              title: "Error en la solicitud",
              text: "Error en la conexión con el backend :", error
            });
          });

      } else {
        Swal.fire({
          icon: "error",
          title:'Error de aprobación',
          text: "Solo se pueden aprobar solicitudes de cambios de turnos cuando estadoAdm: pendiente y estadoEmp: aprobado",

        });

      }
    });

  });

</script>

<!-- Script boton eliminar o des aprobar cambios de turnos-->
<script>
  document.getElementById("desaprobarCambios").addEventListener("click", function () {
    const datos = [];
    const checkboxesSeleccionados = document.querySelectorAll('.checkbox-item:checked');

    if (checkboxesSeleccionados.length === 0) {
      Swal.fire({
        icon: "warning",
        title: "Ningún elemento seleccionado",
        text: "Por favor, selecciona al menos un cambio de turno para desaprobar.",
      });
      return;
    }

    checkboxesSeleccionados.forEach(checkbox => {
      const fila = checkbox.closest('tr');
      const estadoAdmin = fila.querySelector('.aprobadoAdm')?.textContent.trim().toLowerCase();
    
      if (estadoAdmin === "pendiente") {
        const codigoSolicitanteTabla = fila.querySelector('.codigoSolicitante')?.textContent.trim();
        codigoSolicitante = codigoSolicitanteTabla.replace(/\D/g, "");
        const turnoSolicitanteDiaDeseado = fila.querySelector('.turnoSolicitanteDiaDeseado')?.textContent.trim();
        const codigoReceptorTabla = fila.querySelector('.codigoReceptor')?.textContent.trim();
        const codigoReceptor = codigoReceptorTabla.replace(/\D/g, "");
        const turnoReceptorDiaDeseado = fila.querySelector('.turnoReceptorDiaDeseado')?.textContent.trim();
        const fechaCambioTexto = fila.querySelector('.fechaCambio')?.textContent.trim();
        const peticion = "admin".trim();
        const fechaCambio = /^\d{2}\/\d{2}\/\d{4}$/.test(fechaCambioTexto)
          ? (() => {
            const [d, m, y] = fechaCambioTexto.split('/');
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
          })()
          : fechaCambioTexto;
            datos.push({
              fechaCambio,
              codigoSolicitante,
              codigoReceptor,
              turnoSolicitanteDiaDeseado,
              turnoReceptorDiaDeseado,
              peticion
            });

          fetch("{% url 'desaprobar_solicitudes_cambios_turnos' %}", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ solicitudes: datos })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error("Error en la desaprobación");
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              Swal.fire({
                title: "Solicitudes desaprobadas correctamente",
                text: data.message,
                width: 600,
                padding: "3em",
                color: "#ffffff",
                background: "url(https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExb3lybnlpa2N3eG1ibGkxMmkwYXpmY2xkbXRzN2l2aWpkcjhnZjJlOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/jJQC2puVZpTMO4vUs0/giphy.gif)",
                backdrop: `rgba(198, 215, 207, 0.8)`
              }).then(function () {
                location.reload()
              })

            } else {
              Swal.fire({
                icon: "error",
                title: "No se pudieron desaprobar los cambios",
                text: data.message || "Ocurrió un error inesperado",
              });
            }
          })
          .catch(error => {
            console.error("Error en fetch:", error);
            Swal.fire({
              icon: "error",
              title: "Error en la solicitud",
              text: "Ocurrió un error en la comunicación con el servidor.",
            });
          });

      }else if(estadoAdmin === "aprobado"){
        Swal.fire({
        icon: "warning",
        title: "Error al desaprobar",
        text: "Recuerda que solo es posible desaprobar solicitudes en estado = pendiente",
      });
      }
    });

  


    // Función para obtener CSRF
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });

</script>

<!--Script filtros-->
<script>
  // Acordeón toggle
  document.querySelectorAll('.accordion-header').forEach(hdr => {
    hdr.addEventListener('click', () => {
      hdr.classList.toggle('active');
      const body = hdr.nextElementSibling;
      body.classList.toggle('active');
    });
  });


  // Elementos de filtro
  const filtros = {
    nombre: document.getElementById('filtroNombre'),
    codigo: document.getElementById('filtroCodigo'),
    cargo: document.getElementById('filtroCargo'),
    estado: document.getElementById('filtroEstadoSolicitud')
  };

  // Asignar eventos
  Object.values(filtros).forEach(input => {
    input.addEventListener('input', aplicarFiltros);
    input.addEventListener('change', aplicarFiltros);
  });

  function aplicarFiltros() {

    document.getElementById("tablaBody").style.display = "";

    const valorNombre = filtros.nombre.value.toLowerCase().trim();
    const valorCodigo = filtros.codigo.value.toLowerCase().trim();
    const valorCargo = filtros.cargo.value.toLowerCase().trim();
    const valorEstado = filtros.estado.value.toLowerCase().trim();


    document.querySelectorAll('#tablaDatos tbody tr').forEach(row => {
      const tNombre = row.cells[0].textContent.toLowerCase().trim();
      const regexCodigo = row.cells[1].textContent.toLowerCase().trim()
      const tCodigo = regexCodigo.replace(/\D/g, "" );
      const tCargo = row.cells[2].textContent.toLowerCase().trim();
      const tEstado = row.cells[12].textContent.toLowerCase().trim();

      const coincideNombre = !valorNombre || tNombre.includes(valorNombre);
      const coincideCodigo = !valorCodigo || tCodigo === valorCodigo;
      const coincideCargo = !valorCargo || tCargo === valorCargo; // Comparación exacta
      const coincideEstado = !valorEstado || tEstado === valorEstado;

      row.style.display = (coincideNombre && coincideCodigo && coincideCargo  && coincideEstado) ? 'table-row' : 'none';
    
    });
  }

</script>

<!--Script para escapear el comentario que llega del back-->
<script>
  (function () {
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Convierte "\u000A" y "\n" literales en saltos reales
    function decodeNewlines(s) {
      if (!s) return '';
      return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n').replace(/\r\n/g, '\n');
    }

    document.getElementById('tablaBody').addEventListener('click', e => {
      const btn = e.target.closest('.ver-msg');
      if (!btn) return;

      const title = btn.dataset.title || 'Mensaje';
      const decoded = decodeNewlines(btn.dataset.msg || '');

      Swal.fire({
        title: title,
        html: `<div style="text-align:left; font-size:15px; white-space:pre-wrap; max-height:60vh; overflow:auto;">${escapeHtml(decoded)}</div>`,
        width: 700,
        confirmButtonText: 'Cerrar'
      });
    });
  })();

</script>
<!-- CSRF TOKEN -->
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

<script>
  document.getElementById("btnActivarFiltros").addEventListener("click", function(){
    const acordion = document.getElementById("accordionHeader");

    if(acordion.style.visibility === "visible"){
      acordion.style.visibility = "hidden";
    }else if(acordion.style.visibility === "hidden"){
      acordion.style.visibility = "visible";
    }
   
    
  })
</script>

{% endblock %}