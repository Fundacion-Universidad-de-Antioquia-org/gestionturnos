{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="usuario-bar position-relative">
  <div class="usuario-bar-logo-nombre">
      <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
      <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- Título de la página -->
    <div class="saludo" style="color: #5a9138; font-size: 11px;" >Pre-carga </div>
</div>
  </div>

  <!-- Derecha -->
  <form action="{% url 'logout' %}" method="post" class="flex-shrink-0">
    {% csrf_token %}
    <button class="btn btn-sm btn-danger" type="submit">Cerrar sesión</button>
  </form>
</div>

<!-- Acordeon carga de archivos-->
<div class="accordion-container"  style="margin-top: 14px;">
  <div class="accordion-header"><span class="material-symbols-outlined">upload</span>Carga de Archivos | Pre-carga</div>
  <div class="accordion-body" id="acordeonCarga">
   
    <form action="{% url 'preCarga' %}" method="POST" id="formCargaDatos" enctype="multipart/form-data">
      {% csrf_token %}  
      <div class="filtros-horizontal">
        <div class="filtros-horizontal">
  <div class="filtro-item filtro">
    <label for="file_cargarDatosProno">Datos de revisión - PRONO</label>
    <input type="file" name="file_cargarDatosProno" id="archivoRevision" class="input-archivo">
  </div>
  
</div>
      </div>
      <div style="margin-top: 15px;">
        <button type="submit" class="btn btn-primary" name="action" value="cargar" id="btnCargar">Cargar archivos</button>
      </div>
    </form>
  </div>
</div>

<div id="panelControl">
  <span class="material-symbols-outlined">shield_person</span><div class="titulo-template">Empleados que sobrepasan los 7 dias laborados</div> 
</div>
<table class="styled-table display" id="tablaDatos">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cédula</th>
      <th>Codigo</th>
      <th>Días sin descanso</th>
      <th>Estado</th>
      <th>Semana uno</th>
      <th>Semana dos</th>
    </tr>
  </thead>
  <tbody id="tablaBody" >
    {% for r in dfresultado %}
    <tr>
      <td>{{ r.NOMBRE }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CEDULA }}</td>
      <td>{{ r.CODIGO }}</td>
      <td>{{ r.DIAS_SIN_DESCANSO }}</td>
      <td>{{ r.ESTADO }}</td>
      <td>{{ r.DESCANSO_SEM1 }}</td>
      <td>{{ r.DESCANSO_SEM2 }}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<table class="styled-table display" id="tablaDatosSobecargaTranvia">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cédula</th>
      <th>Codigo</th>
      <th>Días sin descanso</th>
      <th>Estado</th>
      <th>Semana uno</th>
      <th>Semana dos</th>
    </tr>
  </thead>
  <tbody id="tablaBody" >
    {% for r in sobrecargaLaboralTranvia %}
    <tr>
      <td>{{ r.NOMBRE }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CEDULA }}</td>
      <td>{{ r.CODIGO }}</td>
      <td>{{ r.DIAS_SIN_DESCANSO }}</td>
      <td>{{ r.ESTADO }}</td>
      <td>{{ r.DESCANSO_SEM1 }}</td>
      <td>{{ r.DESCANSO_SEM2 }}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div id="panelControl" >  
  <span class="material-symbols-outlined">error</span><div class="titulo-template">Servicios repetidos</div>
</div>

{{ faltantes_lunes_viernes|json_script:"faltantesLv" }}
{{ faltantes_sabado_json|json_script:"faltantesSa" }}
{{ faltantes_domingo_json|json_script:"faltantesDo" }}

{{ faltantes_lunes_viernes_Tranvia|json_script:"faltantesLv_Tranvia" }}
{{ faltantes_sabado_json_Tranvia|json_script:"faltantesSa_Tranvia" }}
{{ faltantes_domingo_jsonTranvia|json_script:"faltantesDo_Tranvia" }}

<table class="styled-table display" id="tablaDatosServiciosRepetidos">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Día</th>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cedula</th>
      <th>Código</th>
      <th>Estación inicial</th>
      <th>Estación final</th>
      <th>Turno</th>
    </tr>
  </thead>
  <tbody>
    {% for r in serviciosRepetidos %}
    <tr>
      <td>{{ r.FECHA|date:"Y/m/d" }}</td>
      <td>{{ r.DIA_SEMANA }}</td>
      <td>{{ r.Nombre }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CODPER }}</td>
      <td>{{ r.NMNIdentificadorDosNomina }}</td>
      <td>{{r.Estacion_ent }}</td>
      <td>{{ r.Estacion_sal }}</td>
      <td>{{ r.CUBIERTO }}</td>
    </tr>
    {% empty %}
    <tr>
       <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}  
  </tbody>
</table>

<table class="styled-table display" id="tablaDatosServiciosRepetidosTranvia">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Día</th>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cedula</th>
      <th>Código</th>
      <th>Estación inicial</th>
      <th>Estación final</th>
      <th>Turno</th>
    </tr>
  </thead>
  <tbody>
    {% for r in serviciosRepetidosTranvia %}
    <tr>
      <td>{{ r.FECHA|date:"Y/m/d" }}</td>
      <td>{{ r.DIA_SEMANA }}</td>
      <td>{{ r.Nombre }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CODPER }}</td>
      <td>{{ r.NMNIdentificadorDosNomina }}</td>
      <td>{{r.Estacion_ent }}</td>
      <td>{{ r.Estacion_sal }}</td>
      <td>{{ r.CUBIERTO }}</td>
    </tr>
    {% empty %}
    <tr>
       <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}  
  </tbody>
</table>


<div id="panelControl" >  
  <span class="material-symbols-outlined">error</span><div class="titulo-template">Servicios Faltantes</div>
</div>

<table class="styled-table display" >
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Rango</th>
      <th>Cantidad</th>
      <th>Codigos turnos</th>
    </tr>
  </thead>
  <tbody id="tablaBody">
    {% for f in faltantes_sabado_json %}
      <tr>
        <td>{{ f.fecha }}</td>
        <td>{{ f.rango }}</td>
        <td>{{ f.cantidad }}</td>
        <td>{{ f.turnos }}</td>
      </tr>
      {% empty %}
        <tr>
          <td colspan="12">No hay registros para validar</td>
        </tr>
    {% endfor %}
      {% for f in  faltantes_domingo_json %}
      <tr>
         <td>{{ f.fecha }}</td>
         <td>{{ f.rango }}</td>
      <td>{{ f.cantidad }}</td>
      <td>{{ f.turnos }}</td>
      </tr>
      {% empty %}
      <tr>
      <td colspan="12">No hay registros para validar</td>
      </tr>
      {% endfor %}
    {% for f in faltantes_lunes_viernes %} 
    <tr>
      <td>{{ f.fecha}}</td>
      <td>{{ f.rango }}</td>
      <td>{{ f.cantidad }}</td>
      <td>{{ f.turnos }}</td>
     </tr>
    {% empty %}
     <tr>
      <td colspan="12">No hay registros para validar</td>
     </tr>
     {% endfor %}
  </tbody>
</table>

<table class="styled-table display" >
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Rango</th>
      <th>Cantidad</th>
      <th>Codigos turnos</th>
    </tr>
  </thead>
  <tbody id="tablaBody">
    {% if  faltantes_lunes_viernes_Tranvia %}
    <tr>
      <td>{{ faltantes_lunes_viernes_Tranvia.fecha }}</td>
      <td>{{ faltantes_lunes_viernes_Tranvia.rango }}</td>
      <td>{{ faltantes_lunes_viernes_Tranvia.cantidad }}</td>
      <td>{{ faltantes_lunes_viernes_Tranvia.turnos }}</td>
     </tr>
     {% else %}
     <tr>
      <td colspan="12">No hay registros para validar</td>
     </tr>
     {% endif %}
     {% if faltantes_sabado_json_Tranvia %}
      <tr>
        <td>{{ faltantes_sabado_json_Tranvia.fecha }}</td>
        <td>{{  faltantes_sabado_json_Tranvia.rango }}</td>
      <td>{{ faltantes_sabado_json_Tranvia.cantidad }}</td>
      <td>{{ faltantes_sabado_json_Tranvia.turnos }}</td>
      </tr>
      {% else %}
      {% endif %}
      {% if faltantes_domingo_json_Tranvia %}
      <tr>
         <td>{{ faltantes_domingo_json_Tranvia.fecha }}</td>
         <td>{{ faltantes_domingo_json_Tranvia.rango }}</td>
      <td>{{ faltantes_domingo_json_Tranvia.cantidad }}</td>
      <td>{{ faltantes_domingo_json_Tranvia.turnos }}</td>
      </tr>
      {% endif %}
      
  </tbody>
</table>

{% endblock %}


{% block scripts %}

<!--Script DOM-->
<script>
    document.addEventListener("DOMContentLoaded",function(){
         Swal.fire({
                title: "¡Bienvenido!",
                text: "RECUERDA EL ORDEN DE LOS ARCHIVOS PARA EVITAR ERRORES",
                icon: "success"
              })
              serviciosFaltantes();
    })
</script>

<script>
  function serviciosFaltantes(){

    const faltantesLv = JSON.parse(document.getElementById("faltantesLv").textContent)
    const faltantesSa = JSON.parse(document.getElementById("faltantesSa").textContent)
    const faltantesDo = "{{ faltantes_domingo_json }}"

  if( faltantesLv != "" ){
     Swal.fire({
                title: "Informe de errores generado correctamente",
                text: "Servicios faltantes L-V:"+ faltantesLv.cantidad + ", Servicios faltantes Sabados: "+ faltantesSa.cantidad,
                icon: "success"
              })
  }
  }

</script>

<script>
      // Acordeón toggle
    document.querySelectorAll('.accordion-header').forEach(hdr => {
      hdr.addEventListener('click', () => {
        hdr.classList.toggle('active');
        const body = hdr.nextElementSibling;
        body.classList.toggle('active');
      });
    });
</script>


<script>
  const indiceColumna = 3
  const filas = document.querySelectorAll("#tablaDatos tr")
  filas.forEach((fila,index)=>{
       if(index === 0) return;

       const celda = fila.cells[indiceColumna];
       
       if(celda){
        const span = celda.querySelector("span");
        dias = parseInt(span.textContent,10);
  
        if(dias >= 1){
          span.style.backgroundColor = "#c51010";
          span.style.color = "white";
          span.style.padding = "7px"; 
          span.style.borderRadius = "8px"; 
        }
        

       }
  })

</script>

<!--Función que formatea los string que llegan desde el backend-->
<script>
  function formatHorariosMessage(raw) {
  try {
    if (!raw || typeof raw !== "string") return "";

    // -------- 1) Normalización / Parseo a objeto --------
    let s = raw.replace(/&#x27;/g, "'").trim();         // desescapa comillas HTML
    if (!s.startsWith("{")) s = `{${s}}`;               // envuelve en llaves si viene A: {...}, B: {...}
    // pone comillas a claves tipo "Lunes viernes" o "Sabado"
    s = s.replace(/([,{]\s*)([A-Za-zÁÉÍÓÚáéíóúüÜñÑ\s]+?)\s*:/g, (m, p1, key) => {
      return `${p1}"${key.trim()}" :`;
    });
    s = s.replace(/'/g, '"');                           // pasa a JSON válido

    // si viniera datetime.date(YYYY,M,D), conviértelo a "YYYY-MM-DD"
    s = s.replace(
      /datetime\.date\(\s*(\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})\s*\)/g,
      (_, y, m, d) => `"${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}"`
    );

    const obj = JSON.parse(s);

    // -------- 2) Normalizaciones de etiquetas --------
    if (obj["Lunes viernes"]) {
      obj["Lunes a viernes"] = obj["Lunes viernes"];
      delete obj["Lunes viernes"];
    }
    if (obj["Sabado"] && !obj["Sábado"]) {
      obj["Sábado"] = obj["Sabado"];
      delete obj["Sabado"];
    }

    // {} -> null
    for (const k of Object.keys(obj)) {
      if (obj[k] && typeof obj[k] === "object" && !Array.isArray(obj[k]) && Object.keys(obj[k]).length === 0) {
        obj[k] = null;
      }
    }

    // -------- 3) Construcción del encabezado (semana sáb → vie) --------
    const fechasISO = [];
    if (obj["Sábado"]?.fecha) fechasISO.push(obj["Sábado"].fecha);
    if (obj["Lunes a viernes"]?.fecha) fechasISO.push(obj["Lunes a viernes"].fecha);
    const isoToDDMMYYYY = iso => iso.split("-").reverse().join("/");

    let encabezado = "Semana (sin fechas)";
    if (fechasISO.length) {
      fechasISO.sort(); // ISO ordena bien
      encabezado = `Semana del ${isoToDDMMYYYY(fechasISO[0])} - ${isoToDDMMYYYY(fechasISO[fechasISO.length - 1])}`;
    }

    // -------- 4) Líneas por día --------
    const lineas = [];
    const diasOrden = ["Sábado", "Domingo", "Lunes a viernes"];

    for (const dia of diasOrden) {
      const b = obj[dia];
      if (b && b.fecha) {
        const fecha = isoToDDMMYYYY(b.fecha);
        const cant = typeof b.cantidad === "number" ? b.cantidad : parseInt(b.cantidad || 0, 10);
        const turnos = Array.isArray(b.turnos) ? b.turnos.join(", ") : "—";
        lineas.push(`${dia} (${fecha}): ${isNaN(cant) ? 0 : cant} turno(s) → ${turnos}`);
      } else {
        lineas.push(`${dia}: Sin turnos`);
      }
    }

    return `${encabezado}\n${lineas.join("\n")}`;
  } catch (err) {
    // fallback: si falla el parseo, devuelve el texto original
    console.error("formatHorariosMessage parse error:", err);
    return String(raw);
  }
}

</script>


{% endblock %}