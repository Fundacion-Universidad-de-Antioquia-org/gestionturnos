{% extends 'base.html' %}
{% load static %}
{% block content %}

{% block styles %}
<!--Estilos indicadores-->
<style>
.indicadores {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-right: 15px;
}

.indicador-card.small {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: white;
  background: rgb(40, 36, 36);
  border-radius: 10px;
  padding: 5px 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: transform 0.3s ease;
  white-space: nowrap;
}

.indicador-card.small:hover {
  transform: scale(1.05);
}

/* Spinner inicial */
.indicador-card.small .spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top: 3px solid #1d5031;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Estado final (sin animación, relleno sólido) */
.indicador-card.small .spinner.done {
  animation: none;
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
}

/* Colores */
.total .spinner.done {
  background-color: #007bff;   /* azul */
}
.sinAsignar .spinner.done {
  background-color: #28a745;   /* amarillo */
}
.repetidos .spinner.done {
  background-color: #28a745;   /* verde */
}
.faltantes .spinner.done {
  background-color: #28a745;   /* rojo  dc3545*/
}
</style>

<style>
 :root{
    --bg-app:#0d1117; --surface:#222121; --text:#e6edf3; --muted:#9aa4af;
    --border:#30363d; --accent:#2f81f7; --accent-2:#1f6feb;
  }
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center;
    background:rgba(0,0,0,.6);
    opacity:0; pointer-events:none; transition:opacity .22s ease; z-index:1000;
  }
  .overlay.is-open{ opacity:1; pointer-events:auto; }
  .dialog{
    width:min(480px,92vw); background:var(--surface); color:var(--text);
    border:1px solid var(--border); border-radius:12px; overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
    transform:scale(.98) translateY(6px); opacity:.96;
    transition:transform .22s ease, opacity .22s ease;
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  .overlay.is-open .dialog{ transform:scale(1) translateY(0); opacity:1; }
  .header,.footer{ background:var(--bg-app); padding:14px 16px; }
  .header{
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }
  .title{ margin:0; font-size:1rem }
  .close{
    background:transparent; border:none; color:var(--muted);
    font-size:1.2rem; line-height:1; cursor:pointer;
  }
  .body{ padding:16px; background:var(--surface); }
  .label{ display:block; margin-bottom:.35rem }
  .file{
    width:100%; display:block; padding:.6rem .7rem;
    color:var(--text); background:#1a1f24;
    border:1px solid var(--border); border-radius:.5rem;
  }
  .hint{ margin:.5rem 0 0; color:var(--muted); font-size:.85rem }
  .actions{ display:flex; gap:.6rem; justify-content:flex-end; margin-top:12px }
  .btn{
    border:1px solid var(--border); background:transparent;
    color:var(--text); padding:.6rem .9rem; border-radius:.6rem; cursor:pointer;
  }
  .btn.primary{ background:var(--accent); border:none; color:#fff; }
  .btn.primary:hover{ background:var(--accent-2); }
  @media (prefers-reduced-motion: reduce){ .overlay,.dialog{ transition:none !important; } }
</style>
{% endblock %}

<section class="usuario-bar-section">
<div class="usuario-bar position-relative">
  <div class="usuario-bar-logo-nombre">
      <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
      <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- Título de la página -->
    <div class="saludo" style="color: #5a9138; font-size: 11px;" >Pre-carga </div>
</div>
<div class="usuario-bar-centro">  
    <button title="Activar o desactivar filtros" onclick="openUploadModal()" ><span class="material-symbols-outlined" for="upload-modal-toggle">upload</span></button>
  </div>
  </div>

    <div class="indicadores">
 
  <div class="indicador-card small sinAsignar">
    <div class="spinner"></div>
    <span id="txt-sinAsignar">Cargando...</span>
  </div>

  <div class="indicador-card small repetidos">
    <div class="spinner"></div>
    <span id="txt-repetidos">Cargando...</span>
  </div>

  <div class="indicador-card small faltantes">
    <div class="spinner"></div>
    <span id="txt-faltantes">Cargando...</span>
  </div>
</div>

 <!-- Derecha -->
  <form action="{% url 'logout' %}" method="post" class="flex-shrink-0">
    {% csrf_token %}
    <button class="btn btn-sm btn-danger" type="submit">Cerrar sesión</button>
  </form>
</div>
</section>

<div id="uploadOverlay" class="overlay" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="um-title">
    <div class="header">
      <h2 id="um-title" class="title">Subir archivo</h2>
      <button id="closeModalBtn" class="close" aria-label="Cerrar">×</button>
    </div>

    <form id="uploadForm"
          class="body"
          action="{% url 'preCarga' %}"
          method="POST"
          enctype="multipart/form-data">
          {% csrf_token %}
      <label for="um-file" class="label">Selecciona un archivo</label>
      <input id="um-file" class="file" name="file_cargarDatosProno" type="file" required />
      <p class="hint">Selecciona y presiona “Subir”.</p>

      <div class="footer">
        <div class="actions">
          <button type="button" id="cancelBtn" class="btn">Cancelar</button>
          <button type="submit" id="uploadBtn" class="btn primary">Subir</button>
        </div>
      </div>
    </form>
  </div>
</div>

<section class="panelControl-section">
<div id="panelControl">
  <span class="material-symbols-outlined">shield_person</span><div class="titulo-template">Empleados que sobrepasan los 7 dias laborados</div> 
</div>
</section>

<section class="table-section">
<table class="styled-table display" id="tablaDatos">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cédula</th>
      <th>Codigo</th>
      <th>Días sin descanso</th>
      <th>Estado</th>
      <th>Semana uno</th>
      <th>Semana dos</th>
    </tr>
  </thead>
  <tbody id="tablaBody" >
    {% for r in dfresultado %}
    <tr>
      <td>{{ r.NOMBRE }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CEDULA }}</td>
      <td>{{ r.CODIGO }}</td>
      <td>{{ r.DIAS_SIN_DESCANSO }}</td>
      <td>{{ r.ESTADO }}</td>
      <td>{{ r.DESCANSO_SEM1 }}</td>
      <td>{{ r.DESCANSO_SEM2 }}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</section>

<section class="table-section">
<table class="styled-table display" id="tablaDatosSobecargaTranvia">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cédula</th>
      <th>Codigo</th>
      <th>Días sin descanso</th>
      <th>Estado</th>
      <th>Semana uno</th>
      <th>Semana dos</th>
    </tr>
  </thead>
  <tbody id="tablaBody" >
    {% for r in sobrecargaLaboralTranvia %}
    <tr>
      <td>{{ r.NOMBRE }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CEDULA }}</td>
      <td>{{ r.CODIGO }}</td>
      <td>{{ r.DIAS_SIN_DESCANSO }}</td>
      <td>{{ r.ESTADO }}</td>
      <td>{{ r.DESCANSO_SEM1 }}</td>
      <td>{{ r.DESCANSO_SEM2 }}</td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</section>

<section class="panelControl-section">
<div id="panelControl" >  
  <span class="material-symbols-outlined">error</span><div class="titulo-template">Servicios repetidos</div>
</div>
</section>

{{ faltantes_lunes_viernes|json_script:"faltantesLv" }}
{{ faltantes_sabado_json|json_script:"faltantesSa" }}
{{ faltantes_domingo_json|json_script:"faltantesDo" }}

{{ faltantes_lunes_viernes_Tranvia|json_script:"faltantesLv_Tranvia" }}
{{ faltantes_sabado_json_Tranvia|json_script:"faltantesSa_Tranvia" }}
{{ faltantes_domingo_jsonTranvia|json_script:"faltantesDo_Tranvia" }}

<section class="table-section">
<table class="styled-table display" id="tablaDatosServiciosRepetidos">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Día</th>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cedula</th>
      <th>Código</th>
      <th>Estación inicial</th>
      <th>Estación final</th>
      <th>Turno</th>
    </tr>
  </thead>
  <tbody>
    {% for r in serviciosRepetidos %}
    <tr>
      <td>{{ r.FECHA|date:"Y/m/d" }}</td>
      <td>{{ r.DIA_SEMANA }}</td>
      <td>{{ r.Nombre }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CODPER }}</td>
      <td>{{ r.NMNIdentificadorDosNomina }}</td>
      <td>{{r.Estacion_ent }}</td>
      <td>{{ r.Estacion_sal }}</td>
      <td>{{ r.CUBIERTO }}</td>
    </tr>
    {% empty %}
    <tr>
       <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}  
  </tbody>
</table>
</section>

<section class="table-section">
<table class="styled-table display" id="tablaDatosServiciosRepetidosTranvia">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Día</th>
      <th>Nombre</th>
      <th>Cargo</th>
      <th>Cedula</th>
      <th>Código</th>
      <th>Estación inicial</th>
      <th>Estación final</th>
      <th>Turno</th>
    </tr>
  </thead>
  <tbody>
    {% for r in serviciosRepetidosTranvia %}
    <tr>
      <td>{{ r.FECHA|date:"Y/m/d" }}</td>
      <td>{{ r.DIA_SEMANA }}</td>
      <td>{{ r.Nombre }}</td>
      <td>{{ r.CARGO }}</td>
      <td>{{ r.CODPER }}</td>
      <td>{{ r.NMNIdentificadorDosNomina }}</td>
      <td>{{r.Estacion_ent }}</td>
      <td>{{ r.Estacion_sal }}</td>
      <td>{{ r.CUBIERTO }}</td>
    </tr>
    {% empty %}
    <tr>
       <td colspan="12">No hay registros para validar</td>
    </tr>
    {% endfor %}  
  </tbody>
</table>
</section>

<section class="panelControl-section">
<div id="panelControl" >  
  <span class="material-symbols-outlined">error</span><div class="titulo-template">Servicios Faltantes</div>
</div>
</section>

<section class="table-section">
<table class="styled-table display" >
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Rango</th>
      <th>Cantidad</th>
      <th>Codigos turnos</th>
    </tr>
  </thead>
  <tbody id="tablaBody">
    {% for f in faltantes_sabado_json %}
      <tr>
        <td>{{ f.fecha }}</td>
        <td>{{ f.rango }}</td>
        <td>{{ f.cantidad }}</td>
        <td>{{ f.turnos }}</td>
      </tr>
      {% empty %}
        <tr>
          <td colspan="12">No hay registros para validar</td>
        </tr>
    {% endfor %}
      {% for f in  faltantes_domingo_json %}
      <tr>
         <td>{{ f.fecha }}</td>
         <td>{{ f.rango }}</td>
      <td>{{ f.cantidad }}</td>
      <td>{{ f.turnos }}</td>
      </tr>
      {% empty %}
      <tr>
      <td colspan="12">No hay registros para validar</td>
      </tr>
      {% endfor %}
    {% for f in faltantes_lunes_viernes %} 
    <tr>
      <td>{{ f.fecha}}</td>
      <td>{{ f.rango }}</td>
      <td>{{ f.cantidad }}</td>
      <td>{{ f.turnos }}</td>
     </tr>
    {% empty %}
     <tr>
      <td colspan="12">No hay registros para validar</td>
     </tr>
     {% endfor %}
  </tbody>
</table>
</section>

<section class="table-section">
<table class="styled-table display" >
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Rango</th>
      <th>Cantidad</th>
      <th>Codigos turnos</th>
    </tr>
  </thead>
  <tbody id="tablaBody">
    {% if  faltantes_lunes_viernes_Tranvia %}
    <tr>
      <td>{{ faltantes_lunes_viernes_Tranvia.fecha }}</td>
      <td>{{ faltantes_lunes_viernes_Tranvia.rango }}</td>
      <td>{{ faltantes_lunes_viernes_Tranvia.cantidad }}</td>
      <td>{{ faltantes_lunes_viernes_Tranvia.turnos }}</td>
     </tr>
     {% else %}
     <tr>
      <td colspan="12">No hay registros para validar</td>
     </tr>
     {% endif %}
     {% if faltantes_sabado_json_Tranvia %}
      <tr>
        <td>{{ faltantes_sabado_json_Tranvia.fecha }}</td>
        <td>{{  faltantes_sabado_json_Tranvia.rango }}</td>
      <td>{{ faltantes_sabado_json_Tranvia.cantidad }}</td>
      <td>{{ faltantes_sabado_json_Tranvia.turnos }}</td>
      </tr>
      {% else %}
      {% endif %}
      {% if faltantes_domingo_json_Tranvia %}
      <tr>
         <td>{{ faltantes_domingo_json_Tranvia.fecha }}</td>
         <td>{{ faltantes_domingo_json_Tranvia.rango }}</td>
      <td>{{ faltantes_domingo_json_Tranvia.cantidad }}</td>
      <td>{{ faltantes_domingo_json_Tranvia.turnos }}</td>
      </tr>
      {% endif %}
      
  </tbody>
</table>
</section>
{% endblock %}


{% block scripts %}

<script>
// Función para actualizar un indicador
function actualizarIndicador(clase, idTexto, valor, etiqueta) {
  const spinner = document.querySelector(`.${clase} .spinner`);
  spinner.classList.add("done"); 
  document.getElementById(idTexto).textContent = `${valor} ${etiqueta}`;
}
</script>

<!--Script DOM-->
<script>
    document.addEventListener("DOMContentLoaded",function(){

         Swal.fire({
                title: "¡Bienvenido!",
                text: "¡Importante! Recuerda el orden de las hojas en el archivo de excel",
                icon: "success"
              })
              serviciosFaltantes();
    })

    const solicitudAnual = "{{ solicitudAnual }}" || "0"
    const solicitudAnualAprobadas = "{{ solicitudAnualAprobadas }}" || "0"
    const solicitudAnualPendientes = "{{ solicitudAnualPendientes }}" || "0"
    const solicitudAnualDesaprobadas = "{{ solicitudAnualDesaprobadas }}" || "0"

    const serviciosFaltantesSabados = "{{cantidadSabados}}"
    
    setTimeout(()=>{
      
      actualizarIndicador("sinAsignar", "txt-sinAsignar", 0, "Servicios sin asignar");
      actualizarIndicador("repetidos", "txt-repetidos", 0, "Servicios repetidos");
      actualizarIndicador("faltantes", "txt-faltantes",  0, "Servicios Faltantes");
    }, 2000);
</script>

<script>
  function serviciosFaltantes(){

    const faltantesLv = JSON.parse(document.getElementById("faltantesLv"))
    const faltantesSa = JSON.parse(document.getElementById("faltantesSa"))
    const faltantesDo = "{{ faltantes_domingo_json }}"

    alert(faltantesSa.cantidad.value)

  if( faltantesLv != "" ){
     Swal.fire({
                title: "Informe de errores generado correctamente",
                text: "Servicios faltantes L-V:"+ faltantesLv.cantidad + ", Servicios faltantes Sabados: "+ faltantesSa.cantidad,
                icon: "success"
              })
  }
  }

</script>

<script>
      // Acordeón toggle
    document.querySelectorAll('.accordion-header').forEach(hdr => {
      hdr.addEventListener('click', () => {
        hdr.classList.toggle('active');
        const body = hdr.nextElementSibling;
        body.classList.toggle('active');
      });
    });
</script>


<script>
  const indiceColumna = 3
  const filas = document.querySelectorAll("#tablaDatos tr")
  filas.forEach((fila,index)=>{
       if(index === 0) return;

       const celda = fila.cells[indiceColumna];
       
       if(celda){
        const span = celda.querySelector("span");
        dias = parseInt(span.textContent,10);
  
        if(dias >= 1){
          span.style.backgroundColor = "#c51010";
          span.style.color = "white";
          span.style.padding = "7px"; 
          span.style.borderRadius = "8px"; 
        }
        

       }
  })

</script>

<!--Función que formatea los string que llegan desde el backend-->
<script>
  function formatHorariosMessage(raw) {
  try {
    if (!raw || typeof raw !== "string") return "";

    // -------- 1) Normalización / Parseo a objeto --------
    let s = raw.replace(/&#x27;/g, "'").trim();         // desescapa comillas HTML
    if (!s.startsWith("{")) s = `{${s}}`;               // envuelve en llaves si viene A: {...}, B: {...}
    // pone comillas a claves tipo "Lunes viernes" o "Sabado"
    s = s.replace(/([,{]\s*)([A-Za-zÁÉÍÓÚáéíóúüÜñÑ\s]+?)\s*:/g, (m, p1, key) => {
      return `${p1}"${key.trim()}" :`;
    });
    s = s.replace(/'/g, '"');                           // pasa a JSON válido

    // si viniera datetime.date(YYYY,M,D), conviértelo a "YYYY-MM-DD"
    s = s.replace(
      /datetime\.date\(\s*(\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})\s*\)/g,
      (_, y, m, d) => `"${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}"`
    );

    const obj = JSON.parse(s);

    // -------- 2) Normalizaciones de etiquetas --------
    if (obj["Lunes viernes"]) {
      obj["Lunes a viernes"] = obj["Lunes viernes"];
      delete obj["Lunes viernes"];
    }
    if (obj["Sabado"] && !obj["Sábado"]) {
      obj["Sábado"] = obj["Sabado"];
      delete obj["Sabado"];
    }

    // {} -> null
    for (const k of Object.keys(obj)) {
      if (obj[k] && typeof obj[k] === "object" && !Array.isArray(obj[k]) && Object.keys(obj[k]).length === 0) {
        obj[k] = null;
      }
    }

    // -------- 3) Construcción del encabezado (semana sáb → vie) --------
    const fechasISO = [];
    if (obj["Sábado"]?.fecha) fechasISO.push(obj["Sábado"].fecha);
    if (obj["Lunes a viernes"]?.fecha) fechasISO.push(obj["Lunes a viernes"].fecha);
    const isoToDDMMYYYY = iso => iso.split("-").reverse().join("/");

    let encabezado = "Semana (sin fechas)";
    if (fechasISO.length) {
      fechasISO.sort(); // ISO ordena bien
      encabezado = `Semana del ${isoToDDMMYYYY(fechasISO[0])} - ${isoToDDMMYYYY(fechasISO[fechasISO.length - 1])}`;
    }

    // -------- 4) Líneas por día --------
    const lineas = [];
    const diasOrden = ["Sábado", "Domingo", "Lunes a viernes"];

    for (const dia of diasOrden) {
      const b = obj[dia];
      if (b && b.fecha) {
        const fecha = isoToDDMMYYYY(b.fecha);
        const cant = typeof b.cantidad === "number" ? b.cantidad : parseInt(b.cantidad || 0, 10);
        const turnos = Array.isArray(b.turnos) ? b.turnos.join(", ") : "—";
        lineas.push(`${dia} (${fecha}): ${isNaN(cant) ? 0 : cant} turno(s) → ${turnos}`);
      } else {
        lineas.push(`${dia}: Sin turnos`);
      }
    }

    return `${encabezado}\n${lineas.join("\n")}`;
  } catch (err) {
    // fallback: si falla el parseo, devuelve el texto original
    console.error("formatHorariosMessage parse error:", err);
    return String(raw);
  }
}

</script>

<script>
  (function(){
    const overlay   = document.getElementById('uploadOverlay');
    const closeBtn  = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const form      = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('uploadBtn');

    function onEsc(e){ if(e.key === 'Escape') closeModal(); }
    function openModal(){
      overlay.classList.add('is-open');
      overlay.setAttribute('aria-hidden','false');
      closeBtn?.focus();
      document.addEventListener('keydown', onEsc);
    }
    function closeModal(){
      overlay.classList.remove('is-open');
      overlay.setAttribute('aria-hidden','true');
      document.removeEventListener('keydown', onEsc);
    }

    // Cerrar por UI
    closeBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);
    overlay?.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });

    // Evitar doble submit y mostrar estado
    form?.addEventListener('submit', () => {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Subiendo…';
      // No prevenimos el submit: dejamos que el navegador navegue y renderice la respuesta
    });

    // API pública para abrir/cerrar desde tu botón externo
    window.openUploadModal  = openModal;
    window.closeUploadModal = closeModal;
  })();
</script>


{% endblock %}