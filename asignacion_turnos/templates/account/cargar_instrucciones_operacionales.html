{% extends 'base.html' %}
{% load static %}

{% block styles %}
<style>
  .main-container {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    margin-top: 40px;
    padding: 0 20px;
    
  }

  .form-section, .viewer-section {
    flex: 1;
    min-width: 300px;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    animation: fadeIn 0.6s ease;
  }

  .form-section {
    flex: 0 1 auto; /* Evita que se expanda */
    max-width: 500px; /* Ajusta a tu preferencia */
    background-color: #03000c;
    border-left: 5px solid #5a9138;
    max-height: 70%;
   
  }


.viewer-section iframe,
.viewer-section img,
.viewer-section video {
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 8px;
  object-fit: contain;
  transition: transform 0.3s ease;
}

  .form-label {
    display: block;
    font-weight: 600;
    font-size: 14px;
    color: #ffffff;
    margin-bottom: 8px;
  }

  select,
  input[type="date"],
  input[type="file"],
  input {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 20px;
    transition: border-color 0.3s ease;
  }

  select:focus,
  input:focus {
    border-color: #1D5031;
    outline: none;
  }

.btn-third {
    background-color: #1D5031;
    color: white;
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 20px;
    display: inline-block;
    width: auto;
}


  .btn-third:hover {
    background-color: #154022;
    transform: scale(1.03);
  }

  .text-muted {
    color: #666;
    font-size: 14px;
  }

  .text-center {
    text-align: center;
  }

  .botones-formulario {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    } to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .viewer-section {
  flex: 2;
  width: 100%;
  height: 90vh;
  max-height: 100vh;
  background-color: #0c1118;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.visor-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  height: 90%;
  width: 100%;
  border: 2px dashed #ccc;
  border-radius: 12px;
  background-color: #03000c;
  text-align: center;
  padding: 20px;
  box-sizing: border-box;
  position: relative;
}

.visor-placeholder span {
  font-size: 16px;
  margin-top: 10px;
  color: #666;
}

.visor-placeholder iframe,
.visor-placeholder img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border: none;
  border-radius: 12px;
}



</style>

<style>
  .modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

/* Animación al abrir el modal */
@keyframes slideFadeIn {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Mejora del modal */
.modal-content {
  animation: slideFadeIn 0.4s ease-in-out;
  background-color: #0b0f12;
  color: White;
  padding: 30px 35px;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  width: 90%;
  max-width: 650px;
  max-height: 90vh;
  overflow-y: auto;
}

/* Pregunta */
.pregunta-dinamica {
  background-color: #f5f8f6;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  animation: slideFadeIn 0.3s ease-in-out;
}

/* Inputs y selects del formulario */
.pregunta-dinamica input[type="text"],
.pregunta-dinamica select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 8px;
  margin-bottom: 15px;
  transition: border-color 0.3s ease;
}

.pregunta-dinamica input[type="text"]:focus,
.pregunta-dinamica select:focus {
  border-color: #1D5031;
  outline: none;
}

/* Opción múltiple */
.pregunta-dinamica .opcion-container {
  display: flex;
  align-items: center;
  margin-top: 8px;
}

.pregunta-dinamica .opcion-container input[type="text"] {
  flex: 1;
  margin-right: 12px;
}

.pregunta-dinamica .opcion-container label {
  font-size: 13px;
  color: #444;
  margin-right: 6px;
}


</style>

<style>


.w-id  { width: 25px; }
.w-titulo { width: 200px; }
.w-fechaCarga {width: 85px;}
.w-usuarioCarga { width: 150px;}
.w-tipoArchivo { width: 80px;}
.w-fechaVigencia {width: 100px; }
.w-tipoComunicado { width: 190px;}

  .encabezado-modal {
  display: flex;
  align-items: center; /* centra verticalmente */
  justify-content: center; /* centra horizontalmente */
  gap: 16px;
  margin-bottom: 25px;
  text-align: center;
  flex-wrap: wrap;
}

.logo-modal {
  width: 90px;
  height: auto;
}

.titulo-modal {
  color: #1D5031;
  font-size: 18px;
  font-weight: bold;
  margin: 0;
}

</style>

<!--Modal Comunicados cargados-->
<style>
  .modal-comunicados {

  margin-top: 5%;
  position: fixed;
  inset: 0; /* top/left/right/bottom 0 */
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(12, 17, 24, 0.95);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease;
  z-index: 999;
  /* Evita scroll del body detrás del modal en algunos navegadores */
  overscroll-behavior: contain;
}

.modal-comunicados.mostrar {
  opacity: 1;
  pointer-events: all;
}

/* Contenido del modal */
.modal-comunicados .modal-contenido {
  background: #111826;
  border: 1px solid #00adb5;
  border-radius: 14px;
  width: 85%;
  /* límite de alto para que quepa en pantalla con scroll interno */
  max-height: 90vh;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
  padding: 24px 30px;
  position: relative;
  transform: translateY(-40px);
  animation: subirSuave 0.4s ease forwards;
  color: #e5e5e5;

  /* Scroll vertical suave del contenido del modal */
  overflow-y: auto;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;

  /* Evita que al hacer scroll dentro del modal arrastre el body */
  overscroll-behavior: contain;
}

@keyframes subirSuave {
  to { transform: translateY(0); opacity: 1; }
}

/* Botón cerrar */
.cerrar-modal {
  position: absolute;
  top: 12px;
  right: 18px;
  font-size: 24px;
  cursor: pointer;
  color: #ccc;
  transition: 0.3s ease;
}
.cerrar-modal:hover { color: #00adb5; transform: scale(1.2); }

/* Título */
.modal-contenido h2 {
  font-size: 1.4rem;
  color: #00adb5;
  margin-bottom: 16px;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* ====== ENVOLTORIO SCROLL H (1 clase nueva) ====== */
.tabla-scroller{
  overflow-x: auto;           /* scroll horizontal solo si hace falta */
  -webkit-overflow-scrolling: touch;
  max-width: 100%;
}

/* Tabla */
.tabla-comunicados {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
  color: #f1f1f1;

  /* Para 9 columnas, evita que se compriman demasiado en pantallas chicas */
  min-width: 1100px;          /* ajusta según densidad de tus columnas */
  table-layout: fixed;        /* distribuye mejor el ancho */
}

.tabla-comunicados thead {
  background-color: #00adb5;
  color: #0c1118;
  position: sticky; top: 0;   /* encabezado pegajoso al hacer scroll Y */
  z-index: 1;
}

.tabla-comunicados th,
.tabla-comunicados td {
  /* padding: 10px 14px; */
  text-align: left;
  border-bottom: 1px solid #1f2a38;
  white-space: nowrap;        /* evita quiebres raros de texto */
  overflow: hidden;
  /*text-overflow: ellipsis;   */ /* si algo es muy largo, lo corta con … */
}

.tabla-comunicados tbody tr:hover {
  background-color: rgba(0, 173, 181, 0.15);
}

/* Botón abrir */
.btn-abrir {
  background-color: #00adb5;
  color: #0c1118;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s, transform 0.2s;
}
.btn-abrir:hover { background-color: #06c3cb; transform: scale(1.05); }

/* Ajustes suaves en móviles: reduce tipografía/padding para ganar ancho */
@media (max-width: 768px){
  .modal-comunicados .modal-contenido{ width: 94%; padding: 16px; }
  .tabla-comunicados{ font-size: 0.88rem; min-width: 980px; }
  .tabla-comunicados th, .tabla-comunicados td{ padding: 8px 10px; }
}
</style>
{% endblock %}

{% block content %}
<section class="usuario-bar-section">
<div class="usuario-bar d-flex align-items-center justify-content-between px-3">
<div class="usuario-bar-logo-nombre">
      <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
      <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- Título de la página -->
    <div class="saludo" style="color: #5a9138; font-size: 11px;">
      Comunicaciones e IO's
    </div>
</div>
  </div>

  <form action="{% url 'logout' %}" method="post" class="flex-shrink-0">
    {% csrf_token %}
    <button class="btn btn-sm btn-danger" type="submit">Cerrar sesión</button>
  </form>
</div>
</section>

<div class="main-container">
  <!-- Columna izquierda: Formulario -->
  <div class="form-section">

    <label for="" class="form-label">Titulo comunicado:</label>
    <input type="text" name="" id="tituloComunicado">
    
      <label for="tipo" class="form-label">Tipo de comunicado:</label>
      <select name="tipo" id="tipo">  
        <option value="SELECCIONE">SELECCIONE OPCIÓN</option>
        <option value="INSTRUCCION OPERACIONAL">INSTRUCCIÓN OPERACIONAL</option>
        <option value="PIPO">PIPO</option>
        <option value="COMUNICADOS">COMUNICADOS</option>
        <option value="BOLETINES">BOLETINES</option>
        <option value="LECCIONES APRENDIDAS">LECCIONES APRENDIDAS</option>
      </select>

      <button class="btn-third" type="button" id="agregarCargos" title="Agregar cargos" onclick="botonAgregarCargos()">
        <span class="material-symbols-outlined">
          group_add
          </span>
      </button>

      <div id="listaCargosSeleccionados" style="margin-top: 15px;"></div>
      <input type="hidden" name="cargos_json" id="inputCargosSeleccionados">

      <label for="fechaVigencia"  id="labelFechaVigencia" class="form-label">Fecha de vigencia</label>
      <input id="fechaVigencia" name="fechaVigencia" type="date">

      <label for="archivo" class="form-label">Archivo (PDF, video o imagen)</label>
      <input id="archivo" name="archivo" type="file" accept="application/pdf,image/*,video/*" onchange="previewArchivo(event)">

     <div class="botones-formulario">
        <button class="btn-third" id="cargarArchivos" title="Cargar comunicado"><span class="material-symbols-outlined">upload_file</span></button>
        <button type="button" id="cargarPipo" class="btn-third">Cargar PIPO</button>
        <button class="btn-third" id="traerComunicados" title="Comunicados cargados" ><span class="material-symbols-outlined">table_eye</span></button>
        </div>

  </div>

  <!-- Columna derecha: Visualizador -->
<div class="viewer-section" id="visorArchivo">
  <div class="visor-placeholder" id="placeholder">
    📄🖼️
    <span id="mensajeInicial">Selecciona un archivo PDF, video o imagen para previsualizar</span>

    <iframe id="visorPDF" style="display: none;"></iframe>
    <img id="visorIMG" style="display: none;" />
    <video id="visorVideo" style="display:none;" width="100%" height="100%" controls></video>

  </div>
</div>

</div>

<!--Modal comunicados cargados-->
<!-- Modal de Comunicados -->
<div id="modal-comunicados" class="modal-comunicados">
  <div class="modal-contenido" id = "tablaComunicados">
    <span class="cerrar-modal" id="">&times;</span>
    <h2>Lista de Comunicados</h2>
    <div class = "tabla-scroler">
      <div id="cerrarModalComunicados"></div>
    </div>
    </div>
    
  </div>
</div>

<!-- Modal cargos-->
<div class="modal-overlay" id="modalAgregarCargos" style="display: none;">
  <div class="modal-content">
    <h3>Selecciona cargos para agregar</h3>
    <table class="styled-table display">
      <thead>
        <tr><th>Cargo</th><th>Acción</th></tr>
      </thead>
      <tbody>
        <tr><td>CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO</td><td><button class="btn-third" type="button" onclick="agregarCargo('CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO')">➕Agregar</button></td></tr>
        <tr><td>CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA</td><td><button class="btn-third" type="button" onclick="agregarCargo('CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA')">➕Agregar</button></td></tr>
        <tr><td>OPERADOR(A) DE CONDUCCION</td><td><button class="btn-third" type="button" onclick="agregarCargo('OPERADOR(A) DE CONDUCCION')">➕Agregar</button></td></tr>
        <tr><td>MANIOBRISTA TRENES</td><td><button class="btn-third" type="button" onclick="agregarCargo('MANIOBRISTA TRENES')">➕Agregar</button></td></tr>
        <tr><td>MANIOBRISTA TRANVIA</td><td><button class="btn-third" type="button" onclick="agregarCargo('MANIOBRISTA TRANVIA')">➕Agregar</button></td></tr>
      </tbody>
    </table>
    <button class="btn-eliminar" type="button" onclick="cerrarModalCargos()">Cerrar</button>
  </div>
</div>


<!-- Modal -->
<div id="modalPipo" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    
    <div class="encabezado-modal">
      <img src="{% static 'images/logo2.png' %}" alt="logoFundacion" class="logo-modal">
      <h3 class="titulo-modal">Fundación Universidad de Antioquia - Formulario PIPO</h3>
    </div>

    <div id="preguntas-container"></div>

    <div class="botones-formulario">
      <button type="button" class="btn-third" onclick="agregarPregunta()">➕ Agregar pregunta</button>
      <button type="button" class="btn-third" onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const tipoArchivoSubido = "";
  
    const botonPipo = document.getElementById("cargarPipo");
    const selectTipo = document.getElementById("tipo");
    const fechaVigencia = document.getElementById("fechaVigencia")
    const labelFechaVigencia = document.getElementById("labelFechaVigencia")
    botonPipo.style.display = "none";
    fechaVigencia.style.display = "none";
    labelFechaVigencia.style.display = "none";

    document.getElementById("modalAgregarCargos").style.display = "none";
  
    
    selectTipo.addEventListener("change", function () {
      if (this.value === "PIPO") {
        botonPipo.style.display = "block";
      } else {
        botonPipo.style.display = "none";
      }
    });
  
    selectTipo.addEventListener("change",function(){
        if(this.value === "INSTRUCCION OPERACIONAL"){
             fechaVigencia.style.display = "block";
              labelFechaVigencia.style.display = "block";
      }else{
        labelFechaVigencia.style.display = "none";
        fechaVigencia.style.display = "none";
      }
    })


    
});


function previewArchivo(event) {
  const file = event.target.files[0];
  const visorPDF = document.getElementById("visorPDF");
  const visorIMG = document.getElementById("visorIMG");
  const visorVideo = document.getElementById("visorVideo");
  const mensajeInicial = document.getElementById("mensajeInicial");

  if (file) {
    const url = URL.createObjectURL(file);

    // Oculta todos primero
    visorPDF.style.display = "none";
    visorIMG.style.display = "none";
    visorVideo.style.display = "none";
    mensajeInicial.style.display = "none";

    if (file.type.includes("pdf")) {
      visorPDF.src = url;
      visorPDF.style.display = "block";
      tipoArchivoSubido = "pdf"
    } else if (file.type.startsWith("image")) {
      visorIMG.src = url;
      visorIMG.style.display = "block";
      tipoArchivoSubido = "image"
    } else if (file.type.startsWith("video")) {
      visorVideo.src = url;
      visorVideo.style.display = "block";
      tipoArchivoSubido = "video"
    } else {
      mensajeInicial.style.display = "block";
    }
  }
}

  function mostrarCagarPipoFormulario(){
    document.getElementById("tipo").addEventListener("change", function(){
        const seleccion = this.value;

        if(seleccion === "PIPO"){
             document.getElementById("cargarPipo").style.display = "block";
        }else{
            document.getElementById("cargarPipo").style.display = "block";
        }
   
    })
  }

</script>

<!--Script del formulario - PIPO-->
<script>
  document.getElementById("cargarPipo").addEventListener("click", function () {
  document.getElementById("modalPipo").style.display = "flex";
  document.getElementById("preguntas-container").innerHTML = ""; // limpiar
  agregarPregunta(); // agregar pregunta inicial
});

function cerrarModal() {
  document.getElementById("modalPipo").style.display = "none";
}

let contadorPreguntas = 0;

function agregarPregunta() {
  const contenedor = document.getElementById("preguntas-container");
  const id = contadorPreguntas++;

  const divPregunta = document.createElement("div");
  divPregunta.classList.add("pregunta-dinamica");
  divPregunta.style.marginBottom = "25px";
  divPregunta.innerHTML = `
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <label class="form-label">Pregunta ${id + 1}</label>
    <button type="button" class="btn-third" style="padding: 6px 12px; font-size: 12px;" onclick="eliminarPregunta(this)">
      ❌ Eliminar
    </button>
  </div>

  <input type="text" name="pregunta_${id}" class="form-input" placeholder="Escribe la pregunta" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px;">

  <label class="form-label">Tipo de pregunta</label>
  <select name="tipo_pregunta_${id}" class="form-select" onchange="manejarCambioTipoPregunta(${id}, this)">
    <option value="">Seleccione</option>
    <option value="abierta">Respuesta Abierta</option>
    <option value="multiple">Respuesta Múltiple</option>
  </select>

  <div id="opciones_${id}" style="margin-top: 10px;"></div>
  <hr style="margin-top: 20px;">
`;


  contenedor.appendChild(divPregunta);
}

function manejarCambioTipoPregunta(id, select) {

  const contenedorOpciones = document.getElementById(`opciones_${id}`);
  contenedorOpciones.innerHTML = "";  // Siempre limpiamos antes

  if (select.value === "multiple") {
    const listaOpciones = document.createElement("div");
    listaOpciones.id = `lista_opciones_${id}`;

    const btnAgregarOpcion = document.createElement("button");
    btnAgregarOpcion.type = "button";
    btnAgregarOpcion.className = "btn-third";
    btnAgregarOpcion.innerText = "➕ Agregar opción";
    btnAgregarOpcion.style.marginTop = "10px";
    btnAgregarOpcion.onclick = function () {
      const numOpciones = listaOpciones.children.length;

      const div = document.createElement("div");
      div.className = "opcion-container";

      const input = document.createElement("input");
      input.type = "text";
      input.name = `opcion_${id}[]`;
      input.placeholder = `Opción ${numOpciones + 1}`;
      input.required = true;

      const label = document.createElement("label");
      label.innerText = "Correcta";

      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = `correcta_${id}`;
      radio.value = numOpciones;

      div.appendChild(input);
      div.appendChild(label);
      div.appendChild(radio);
      listaOpciones.appendChild(div);
    };

    contenedorOpciones.appendChild(listaOpciones);
    contenedorOpciones.appendChild(btnAgregarOpcion);

    // Agrega una opción por defecto
    btnAgregarOpcion.click();
  }

  else if (select.value === "abierta") {
    const textarea = document.createElement("textarea");
    textarea.name = `respuesta_abierta_${id}`;
    textarea.placeholder = "Respuesta del usuario...";
    textarea.rows = 3;
    textarea.style = "width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;";

    contenedorOpciones.appendChild(textarea);
  }
}

function eliminarPregunta(boton) {
  const pregunta = boton.closest(".pregunta-dinamica");
  if (pregunta) {
    pregunta.remove();
  }
}
</script>

<!--Scripts boton agregar cargos-->
<script>
 function botonAgregarCargos(){
    document.getElementById("modalAgregarCargos").style.display = "block";
 }
 function cerrarModalCargos(){
  document.getElementById("modalAgregarCargos").style.display = "none";
 
 }
</script>

<!--Funciones para agregar el cargo dinamicamente-->
<script>
let cargosSeleccionados = [];

function botonAgregarCargos() {
  document.getElementById("modalAgregarCargos").style.display = "flex";
}

function cerrarModalCargos() {
  document.getElementById("modalAgregarCargos").style.display = "none";
}

function agregarCargo(cargo) {
  if (!cargosSeleccionados.includes(cargo)) {
    cargosSeleccionados.push(cargo);
    actualizarVistaCargos();
  }
}

function eliminarCargo(index) {
  cargosSeleccionados.splice(index, 1);
  actualizarVistaCargos();
}

function actualizarVistaCargos() {
  const contenedor = document.getElementById("listaCargosSeleccionados");
  const inputHidden = document.getElementById("inputCargosSeleccionados");

  contenedor.innerHTML = "";

  cargosSeleccionados.forEach((cargo, index) => {
    const div = document.createElement("div");
    div.innerHTML = `
      <span style="background-color: #eef4ef; padding: 6px 10px; border-radius: 6px; display: inline-block; margin-right: 8px;">
        ${cargo}
        <button type="button" onclick="eliminarCargo(${index})" style="margin-left: 10px; color: red; background: none; border: none; font-weight: bold;">❌</button>
      </span>
    `;
    contenedor.appendChild(div);
  });

  inputHidden.value = JSON.stringify(cargosSeleccionados);
}
</script>

<!--Funcion para el boton cargar/PDF/VIDEO/IMAGEN-->
<script>
  document.getElementById("cargarArchivos").addEventListener("click",function(){

    const formData = new FormData()
    let usuarioLogeado = "{{ usuarioLogeado }}"
  
    tipoComunicado = document.getElementById("tipo").value
    cargos = document.getElementById("inputCargosSeleccionados").value;
    fechaVigenciaCargar = document.getElementById("fechaVigencia").value
    tituloComunicado = document.getElementById("tituloComunicado").value.toUpperCase().trim();
    
    const archivoCargar = document.getElementById("archivo").files[0];

    if(tipoComunicado !== "SELECCIONE" && cargos !== "" && archivoCargar && tituloComunicado !== ""){

      if(tipoComunicado == "INSTRUCCION OPERACIONAL"){

        if(fechaVigenciaCargar !== ""){
          /* Solo IO ->*/
          formData.append('tituloComunicado',tituloComunicado.toUpperCase())
          formData.append('tipoComunicado', tipoComunicado.toUpperCase())
          formData.append('cargos', cargos)
          formData.append('fechaVigenciaCargar', fechaVigenciaCargar)
          formData.append('archivoCargar', archivoCargar)
          formData.append('usuarioLogeado', usuarioLogeado.toUpperCase())
          formData.append('tipoArchivo' , tipoArchivoSubido)

        try{
          fetch("{% url 'cargarComunicados' %}",{
          method: "POST",
          headers:{'X-CSRFToken': getCSRFToken()},
          body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success){
              Swal.fire({
                title: "¡Carga exitosa!",
                text: data.message,
                icon: "success"
              })
              .then(()=>{
                location.reload()
              })
            }
          })

        } catch ( error){
            Swal.fire({
                title: "Exception",
                text: error,
                icon: "error"
              })
        }
        }else{
           Swal.fire({
            icon: "error",
            title: "Fecha invalida",
            text: "Debe ingresar una fecha de vigencia valida"
            })
        };
      
      }else{
          /*Comunicados, boletines, lecciones aprendidas -*/
        formData.append('tituloComunicado',tituloComunicado.toUpperCase())
        formData.append('tipoComunicado', tipoComunicado.toUpperCase())
        formData.append('cargos', cargos)
        formData.append('fechaVigenciaCargar', fechaVigenciaCargar)
        formData.append('archivoCargar', archivoCargar)
        formData.append('usuarioLogeado', usuarioLogeado.toUpperCase())
        formData.append('tipoArchivo' , tipoArchivoSubido)


         try{

          fetch("{% url 'cargarComunicados' %}",{
          method: "POST",
          headers:{'X-CSRFToken': getCSRFToken()},
          body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success){

              Swal.fire({
                title: "¡Carga exitosa!",
                text: data.message,
                icon: "success"
              })
              .then(()=>{  
                location.reload()
              })
              
            }
          })
          

        } catch ( error){
            Swal.fire({
                title: "Exeption",
                text: error,
                icon: "error"
              })
        }
      }
       
    }else{
       Swal.fire({
            icon: "error",
            title: "Opps Faltan campos por diligenciar",
            text: "📑Revisa: Titulo comunicado,  tipo de comunicado y el archivo cargado "
        });
    }



  })
</script>

<!--Token para el formulario-->
<script>
    function getCSRFToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    let c = cookie.trim();
    if (c.startsWith(name + '=')) {
      return decodeURIComponent(c.substring(name.length + 1));
    }
  }
  return null;
}
</script>


<script>
const modalCom = document.getElementById("modal-comunicados");
const btnAbrirCom = document.getElementById("traerComunicados");
const btnCerrarCom = document.getElementById("cerrarModalComunicados");

  btnAbrirCom.addEventListener("click", function(){
    
    const contenedor = document.getElementById('tablaComunicados')
 
    fetch("{% url 'getTodosComunicados' %}",{
          method: "GET",
          headers:{/*"Content-Type": "application/json",*/
                  "X-CSRFToken": getCookie("csrftoken")}
          })
          .then(response => response.json())
          .then(data =>{
            
              if(data.success){
                contenedor.innerHTML = `
                <table class="tabla-comunicados"> 
                  <thead>
                    <tr> 
                    <th class = "w-id">Id</th>
                    <th class = "w-titulo">Titulo</th>
                    <th class = "w-fechaCarga">Fecha carga</th>
                    <th class = "w-usuarioCarga">Usuario carga</th>
                    <th class = "w-tipoComunicado">Tipo comunicado</th>
                    <th class = "w-fechaVigencia" >Fecha vigencia</th>
                    
                    <th class = "w-tipoArchivo" >Tipo archivo</th>
                    <th>Cargo visualización</th>  
                    </tr>
                  </thead>
                  <tbody>
                  ${ data.comunicados.map(c => `
                    <tr>
                    <td>${c.id}</td>
                    <td>${c.titulo}</td>
                    <td>${c.fechaCarga}</td>
                    <td>${c.usuarioCarga}</td>
                    <td>${c.tipoComunicado}</td>
                    <td>${c.fechaVigencia}</td>
                    
                    <td>${c.tipoArchivo}</td>
                    <td>${c.cargoVisualizacion}</td>
                    </tr>
                  
                  `).join('')
                  }
                    </tbody>
                  </table>
                
                `;
                
              modalCom.classList.add("mostrar");
              }else{
                alert("error")
              }
          })

  })

 
  btnCerrarCom.onclick = () => modalCom.classList.remove("mostrar");
  window.onclick = (e) => {
    if (e.target === modalCom) modalCom.classList.remove("mostrar");
  };
  </script>

<script>
  function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>


{% endblock %}
