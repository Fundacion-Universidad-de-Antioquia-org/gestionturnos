{% extends 'base.html' %}
{% load static %}
{% static 'images/admin_img.png' as fallback_avatar %}

{% block title %}Gestión de turnos -  {{usuarioLogeado}}{% endblock %}
{% block titulo_template%} Cargué de horarios y {% endblock %}

{%block styles %}
<style>
    /* Fondo bloqueante */
#loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  pointer-events: all;
}

/* Ocultar por defecto */
#loader-overlay.hidden {
  display: none;
}

/* Contenedor del loader */
.loader-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Loader circular */
.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #1d5031; /* verde institucional */
  border-radius: 50%;
  width: 80px;
  height: 80px;
  animation: spin 1s linear infinite;
}

/* Animación */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Texto debajo del loader */
.loader-title {
  margin-top: 20px;
  font-size: 1.5rem;
  color: white;
  text-align: center;
  font-weight: bold;
}

</style>

{% endblock %}
{% block content %}

{% load static %}
<section class="usuario-bar-section">
<div class="usuario-bar d-flex align-items-center justify-content-between px-3">

<!-- Sección Izquierda: Foto + Usuario -->
<div class="usuario-bar-logo-nombre">
    <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
  <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- Título de la página -->
    <div class="saludo" style="color: #5a9138; font-size: 11px;">Horarios & Sucesiones</div>
  </div>
  <div class="usuario-bar-centro">
    <button title="Buscar sucesión por codigo | fecha" id="btnBuscarSucesion" ><span class="material-symbols-outlined">search</span></button>
    <button><span class="material-symbols-outlined" onclick="abrirModalHorarios()">find_replace</span></button>
    <button><span class="material-symbols-outlined" style="color: white;">browse_activity</span></button>
    
  </div>
  </div>

</div>
</section>

<div id="loader-overlay" class="hidden">
  <div class="loader-container">
    <div class="loader"></div>
    <h2 class="loader-title">Cargando datos...</h2>
  </div>
</div>

<!-- Acordeon carga de archivos-->
 <section class="acordion-section">
<div class="accordion-container"  style="margin-top: 14px;">
  <div class="accordion-header"><span class="material-symbols-outlined">upload</span>Carga de Archivos</div>
  <div class="accordion-body" id="acordeonCarga">
    <div class="" id="botonesCargos">
      <button class="btn btn-third" id="trenes">Trenes</button>
      <button class="btn btn-third" id="tranvia">Tranvia</button>
      <button class="btn btn-third" id="maniobras">Maniobras</button>
      <button class="btn btn-third" id="operadores">Operadores de conducción</button>
    </div>

    <form action="{% url 'vista_cargarSucesionTrenes' %}" method="post" id="formCargaDatos"  enctype="multipart/form-data">
      {% csrf_token %}
      <div class="filtros-horizontal">
        <div class="filtros-horizontal">
  <div class="filtro-item filtro" id="lunesViernes">
    <label for="file_cuadroServicios">Cuadro de servicios Lunes a Viernes</label>
    <input type="file" name="file_cuadroServicios" id="archivoCuadroTurnos" class="input-archivo">
  </div>
  <div class="filtro-item filtro" id="sabados" >
    <label for="file_cuadroServiciosSabado">Cuadro de servicios Sábados</label>
    <input type="file" name="file_cuadroServiciosSabado" id="archivoCuadroTurnosSabados" class="input-archivo">
  </div>
  <div class="filtro-item filtro" id="domingos">
    <label for="file_cuadroServiciosDomingo">Cuadro de servicios Domingos y Festivos</label>
    <input type="file" name="file_cuadroServiciosDomingo" id="archivoCuadroTurnosDomingo" class="input-archivo">
  </div>
  <div class="filtro-item filtro" id="especial">
    <label for="file_cuadroServiciosEspecial">Cuadro de servicios Especiales</label>
    <input type="file" name="file_cuadroServiciosEspecial" id="archivoCuadroTurnosEspeciales" class="input-archivo">
  </div>
  <div class="filtro-item filtro" id="sucesion">
    <label for="file_sucesion">Archivo Sucesión</label>
    <input type="file" name="file_sucesion" id="archivoSucesion" class="input-archivo">
  </div>
</div>

      </div>
      <div style="margin-top: 15px;">
        <button type="submit" class="btn btn-primary" name="action" value="cargar" id="btnCargar">Cargar archivos</button>
        <button type="submit" class="btn btn-primary" name="action" value="publicar" id="btnPublicar">Publicar sucesión</button>
        <button type="button" onclick="abrirModalHorarios()" class="btn-eliminar" id="btnEliminar" >Actualizar cuadro de turnos</button>
      </div>
    </form>
  </div>
</div>
</section>

    <!-- Acordeón de filtros -->
     <section class="acordion-section">
<div class="accordion-container">
  <div class="accordion-header" id="acordionHeader"> <span class="material-symbols-outlined">filter_alt</span> Filtros de Búsqueda</div>
  <div class="accordion-body cargar-horario" id="acordionBody">
    <div class="filtros-horizontal">
      <div class="filtro-item">
        <label for="filtroNombre">Nombre:</label>
        <input type="text" id="filtroNombre" placeholder="Buscar por nombre">
      </div>
      <div class="filtro-item">
        <label for="filtroCodigo">Código:</label>
        <input type="text" id="filtroCodigo" placeholder="Buscar por código">
      </div>
      <div class="filtro-item">
        <label for="filtroTurno">Turno:</label>
        <input type="text" id="filtroTurno" placeholder="Buscar por turno">
      </div>
      <div class="filtro-item">
        <label for="filtroCargo">Cargo:</label>
        <select name="select" id="filtroCargo">
            <option value="">Todos</option>
            <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO" selected>CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO</option>
            <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA" >CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA</option>
            <option value="OPERADOR(A) DE CONDUCCION" >OPERADOR DE CONDUCCION</option>
            <option value="MANIOBRISTA TRENES" >MANIOBRISTA TRENES</option>
            <option value="MANIOBRISTA TRANVIA" >MANIOBRISTA TRANVIA</option>
            <option value="INCONSISTENCIA">INCONSISTENCIA</option>
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroEstado">Estado:</label>
        <select name="select" id="filtroEstado">
            <option value="revision" selected >revision</option>
            <option value="publicado">publicado</option>
            
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Fecha:</label>
        <input type="datetime" id="filtroFecha">
      </div>
    </div>
  </div>
</div>
</section>

<!-- Tabla de datos-->
 <section class="table-section">
    <table class="styled-table display" id="tablaDatos" >
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Código</th>
                <th>Turno</th> 
                <th>Cargo</th>
                <th>Fecha</th>
                <th>Estación inicio</th>
                <th>Estación final</th>
                <th>Hora inicio</th>
                <th>Hora final</th>
                <th>Particularidades</th>
                <th>Estado</th>
                <th>Usuario carga</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaBody">
                {% for s in datos_sucesion %}
            <tr>
                <td>{{ s.nombre }}</td>
                <td>{{ s.codigo }}</td>
                <td>{{ s.codigo_horario }}</td>
                <td>{%if s.empleado.cargo %}
                    {{s.empleado.cargo}}
                    {% else %}
                    <span style="color: red">INCONSISTENCIA</span>
                    {% endif %}
                </td>
                <td>{{ s.fecha|date:"d/m/Y" }}</td>
                <td>{% if s.horario.inilugar %}
                        {{ s.horario.inilugar }}
                    {% else %}
                        
                    {% endif %}
                </td>
                <td>{% if s.horario.finallugar %}
                        {{s.horario.finallugar}}
                    {% else %}

                    {% endif %}
                </td>

                <td>{{ s.horario.inihora|time:"H:i" }}</td>
                <td>{{ s.horario.finalhora|time:"H:i" }}</td>
                <td>
                    {% if s.horario.observaciones %}
                        {{ s.horario.observaciones }}
                    {% else %}
                        Sin horario asignado
                    {% endif %}
                </td>
                <td>
                    {{s.estado_sucesion}}
                </td>
                <td>{{ s.usuario_carga}}</td>
                <td>
                    <!-- Botones-->
                     <button class="btn-editar" id="editarTablaDatos"><span class="material-symbols-outlined">edit_document</span></button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="12">No hay registros de sucesión</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </section>

<!-- Paginación -->
<div id="paginacion" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px;"></div>

<!-- [ MODALES ] -->
<!--Modal  - editar por filas-->
<div id="modalEditar" class="modal-custom">
  <div class="modal-content-custom">
      <div class="modal-header-custom">Actualizar empleado o turno <span class="cerrar-modal" id="cerrarModal">&times;</span>
      </div>

    <label>Nombre</label>
    <input type="text" id="editNombre">

    <label>Código</label>
    <input type="text" id="editCodigo" readonly>

     <div class="filtro-item">
        <label>Cargo</label>
    <select name="" id="editCargo">
        <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO">CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO</option>
        <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO">CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA</option>
        <option value="OPERADOR(A) DE CONDUCCION">OPERADOR(A) DE CONDUCCION</option>
        <option value="MANIOBRISTA TRENES">MANIOBRISTA TRENES</option>
        <option value="MANIOBRISTA TRANVIA">MANIOBRISTA TRANVIA</option>
    </select>
    </div>

    <h3> <label for="">Editar información del turno</label></h3>
    <label>Turno <span style="background-color: #5a9138;" class="material-symbols-outlined">ads_click</span>Click aca para permitir editar</label>
    <input type="text" name="" id="editTurno" >  
     <label>Fecha turno</label>
    <input type="datetime" id="editFecha" readonly>

    <label>Estación de inicio</label>
    <input type="text" id="editEstacionIni">

    <label>Estación final</label>
    <input type="text" id="editEstacionFin">

    <label>Hora de inicio</label>
    <input type="text" id="editHoraIni">

    <label>Hora final</label>
    <input type="text" id="editHoraFin">
    
    <label>Particularidades</label>
    <textarea name="" id="editParticularidades" class="campo-textarea" rows="7"></textarea>

    <div style="text-align: right; margin-top: 15px;">
        <button id="cerrarBotonManual">Cerrar</button>
        <button id="guardarCambios" type="submit">Guardar</button>
       
    </div>

    
  </div>
</div>
<!-- TOKEN DJANGO GLOBAL-->
<input type="hidden" id="csrfTokenGlobal" value="{{ csrf_token }}">

<!--Modal eliminar cuadro de turnos-->
<div id="modalHorarios" class="modal-eliminar">
  <div class="modal-content-eliminar">
    <span class="cerrar-modal-eliminar" onclick="cerrarModalHorarios()">&times;</span>
    <h3>Horarios Cargados Recientemente</h3>
    <div id="contenidoHorarios"></div>
  </div>
</div>

<!--Modal buscar en sucesion -->
<div class="modal-buscarSucesion" id="modalBuscarSucesion">
  <div class="modal-buscarSucesion-contenido">
    <span class="cerrar-buscarSucesion" onclick="cerrarModalBuscarSucesion()">&times;</span>
    <div class="icon-title"><span class="material-symbols-outlined">search</span><h3 class="titulo-buscarSucesion">Buscar sucesión</h3></div>

    <div class="formulario-buscarSucesion">
      <label for="codigo">Código:</label>
      <input type="text" class="input-buscarSucesion" id="codigoSucesion">

      <label for="documentoEmpleado">N° Identificación:</label>  
      <input type="text" class="input-buscarSucesion" id="documentoEmpleado">

      <label for="fechaFinGT">Fecha inicial:</label>
      <input type="date" id="modalFechaInicial" class="input-buscarSucesion">

      <label for="fechaFinGT">Fecha final:</label>
      <input type="date" id="modalFechaFinal" class="input-buscarSucesion">

      <button class="btn-cargar-buscarSucesion" id="btnbuscarSucesion">Buscar</button>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}

<!--Buscar datos*filtro-->
 <script>
  document.getElementById("btnBuscarSucesion").addEventListener("click", function(){
  
    const modalBuscarSucesion = document.getElementById("modalBuscarSucesion");
    modalBuscarSucesion.style.display = "block";

    setTimeout(() => {
    modalBuscarSucesion.classList.add("mostrar");
  }, 10);

  })

  function cerrarModalBuscarSucesion() {
  const modalBuscarSucesion = document.getElementById("modalBuscarSucesion");
  modalBuscarSucesion.classList.remove("mostrar");
  setTimeout(() => {
    modalBuscarSucesion.style.display = "none";
  }, 300); // coincide con el tiempo de transition
}

  document.getElementById("btnbuscarSucesion").addEventListener("click",function(){

    const estado = "publicado";
    const codigo = document.getElementById("codigoSucesion").value
    const fechaInicial = document.getElementById("modalFechaInicial").value
    const fechaFinal = document.getElementById("modalFechaFinal").value

    let bodyTabla = document.getElementById("tablaBody");

    if(codigo !== "" && estado !== "" && fechaInicial !== "" && fechaFinal !== ""){
      
      if(estado !== "publicado"){
        Swal.fire({
                    icon: "warning",
                    title: "Revisa el valor del campo: Estado",
                    text: `Para realizar esta consulta debes seleccionar publicada en el campo: Estado, valor actual: ${estado}`

                      })

      return;
        }
          
           fetch("{% url 'datos_filtro_sucesion' %}",{
      method : "POST",
      headers:{"Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")},
      body: JSON.stringify({
        "codigo":codigo,
        "estado": estado,
        "fechaInicial": fechaInicial,
        "fechaFinal": fechaFinal
      })
    })
    .then(response => response.json())
    .then((data)=>{
      
      
      if(data.success){

        console.log(typeof data); 
        console.log(Object.keys(data)); 
        console.log(data); 
        
        bodyTabla.innerHTML = "";
      
       const rows = data.data.map(emp => `
          <tr>
            <td>${emp.nombre ?? ""}</td>
            <td>${emp.codigo ?? ""}</td>
            <td>${emp.codigo_horario ?? ""}</td>
            <td>${emp.cargo ?? ""}</td>
            <td>${emp.fecha ?? ""}</td>
            <td>${emp.estado_inicio ?? ""}</td>
            <td>${emp.estado_fin ?? ""}</td>
            <td>${emp.hora_inicio ?? ""}</td>
            <td>${emp.hora_fin ?? ""}</td>
            <td>${emp.particularidades ?? ""}</td>
            <td>${emp.estado_sucesion ?? ""}</td>
            <td>${emp.usuario_carga ?? ""}</td>
            <td><button class="btn-editar" id="editarTablaDatos"><span class="material-symbols-outlined">edit_document</span></button></td>
          </tr>
        `).join("");

        bodyTabla.innerHTML = rows;
        bodyTabla.style.display = "table-row-group";

         cerrarModalBuscarSucesion()
      
      }else{
          Swal.fire({
                    icon: "error",
                    title: "Error con la captura de los datos",
                    text: data.message

                      })
      }
    })
    .catch(error =>Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: error

                      }))
    }else{

          Swal.fire({
                    icon: "error",  
                    title: "Se detectaron campos vacios",
                    text: "Por favor valida el campo  codigo, fecha inicial o final"
                      })

    }
    
   
  })
 </script>

<!--Script filtros-->
<script>
  // Acordeón toggle
    document.querySelectorAll('.accordion-header').forEach(hdr => {
      hdr.addEventListener('click', () => {
        hdr.classList.toggle('active');
        const body = hdr.nextElementSibling;
        body.classList.toggle('active');
      });
    });



  // Elementos de filtro
  const filtros = {
    nombre: document.getElementById('filtroNombre'),
    codigo: document.getElementById('filtroCodigo'),
    turno: document.getElementById('filtroTurno'),
    cargo: document.getElementById('filtroCargo'),
    fecha: document.getElementById('filtroFecha'),
    estado: document.getElementById('filtroEstado'),
  };

  // Asignar eventos
  Object.values(filtros).forEach(input => {
    input.addEventListener('input', aplicarFiltros);
    input.addEventListener('change', aplicarFiltros);
  });

function aplicarFiltros() {
  
  document.getElementById("tablaBody").style.display = "";

  // Lee los filtros (si alguno no existe, usa string vacío)
  const valorNombre = (filtros?.nombre?.value || "").toLowerCase().trim();
  const valorCodigo = (filtros?.codigo?.value || "").toLowerCase().trim();
  const valorTurno  = (filtros?.turno?.value  || "").toLowerCase().trim();
  const valorCargo  = (filtros?.cargo?.value  || "").toLowerCase().trim();
  const valorFecha  = (filtros?.fecha?.value  || "").trim();
  const valorEstado = (filtros?.estado?.value || "").toLowerCase().trim();

  // Constantes de índice para no “adivinar” números mágicos
  const COL_NOMBRE = 0;
  const COL_CODIGO = 1;
  const COL_TURNO  = 2;
  const COL_CARGO  = 3;
  const COL_FECHA  = 4;
  const COL_ESTADO = 10; // ajusta si tu tabla cambia

  document.querySelectorAll('#tablaDatos tbody tr').forEach((row, idx) => {
    const cells = row.cells;
    if (!cells || cells.length === 0) {
      // Fila “especial”, como mensaje de vacío o separador
      // Puedes ocultarla o dejarla tal cual
      return;
    }

    // Si alguna columna puede no existir en ciertas filas, usa optional chaining y valor por defecto
    const safeTxt = (el) => (el?.textContent || '').trim();
    const safeTxtLower = (el) => safeTxt(el).toLowerCase();

    // Si te falta alguna col en algunas filas, esto evita romper
    const tNombre = safeTxtLower(cells[COL_NOMBRE]);
    const tCodigo = safeTxtLower(cells[COL_CODIGO]);
    const tTurno  = safeTxtLower(cells[COL_TURNO]);
    const tCargo  = safeTxtLower(cells[COL_CARGO]);
    const tFecha  = safeTxt(cells[COL_FECHA]); // fecha la comparas exacta, no bajas a lower

    // Para estado, intenta por índice y, si no existe, busca por clase/atributo
    const estadoCell = cells[COL_ESTADO] || row.querySelector('.col-estado, [data-col="estado"]');
    const tEstado = safeTxtLower(estadoCell);

    // Comparaciones
    const coincideNombre = !valorNombre || tNombre.includes(valorNombre);
    const coincideCodigo = !valorCodigo || tCodigo === valorCodigo;
    const coincideTurno  = !valorTurno  || tTurno.includes(valorTurno);
    const coincideCargo  = !valorCargo  || tCargo === valorCargo; // exacta
    const coincideFecha  = !valorFecha  || tFecha === valorFecha; // exacta
    const coincideEstado = !valorEstado || tEstado === valorEstado;

    const tablaBody = document.getElementById("tablaBody")
    const tieneFilas = tablaBody.querySelectorAll("tr").length > 1

    if(tieneFilas){
        row.style.display = (coincideNombre && coincideCodigo && coincideTurno &&
                         coincideCargo && coincideFecha && coincideEstado)
                        ? '' : 'none'; 
    }
    
  });
}

/*mostrarPagina(1);*/

</script>

<!--Script paginación-->
<!--Script paginación (respeta los filtros)-->
<script>
  const filasPorPagina = 10;
  let paginaActual = 1;

  function mostrarPagina(pagina) {
    const tbody = document.getElementById("tablaBody");

    // 1) Limpia paginación previa (sin tocar filtros permanentes)
    const todas = Array.from(tbody.querySelectorAll("tr"));
    todas.forEach(tr => tr.style.display = "");

    // 2) Reaplica los filtros si existen (tu función actual)
    if (typeof aplicarFiltros === "function") aplicarFiltros();

    // 3) Toma solo las filas que quedaron visibles por el filtro
    const visibles = Array.from(tbody.querySelectorAll("tr"))
      .filter(tr => tr.style.display !== "none");

    // 4) Cálculo y clamp de página
    const totalPaginas = Math.max(1, Math.ceil(visibles.length / filasPorPagina));
    pagina = Math.min(Math.max(1, pagina), totalPaginas);

    const inicio = (pagina - 1) * filasPorPagina;
    const fin = inicio + filasPorPagina;

    // 5) Oculta por paginación solo fuera del slice (no revierte el filtro)
    visibles.forEach((tr, i) => {
      tr.style.display = (i >= inicio && i < fin) ? "" : "none";
    });

    paginaActual = pagina;
    actualizarControlesPaginacion(totalPaginas);
  }

  function generarPaginacion(totalPaginas, paginaActual) {
    const rango = 2;
    const mostrarPaginas = [];

    if (totalPaginas <= 10) {
      for (let i = 1; i <= totalPaginas; i++) mostrarPaginas.push(i);
    } else {
      const inicio = Math.max(2, paginaActual - rango);
      const fin = Math.min(totalPaginas - 1, paginaActual + rango);

      mostrarPaginas.push(1);
      if (inicio > 2) mostrarPaginas.push("...");
      for (let i = inicio; i <= fin; i++) mostrarPaginas.push(i);
      if (fin < totalPaginas - 1) mostrarPaginas.push("...");
      mostrarPaginas.push(totalPaginas);
    }
    return mostrarPaginas;
  }

  function actualizarControlesPaginacion(totalPaginas) {
    const paginacionDiv = document.getElementById("paginacion");
    paginacionDiv.innerHTML = "";

    // Si no hay filas visibles, no mostramos controles
    const visibles = Array.from(document.querySelectorAll("#tablaBody tr"))
      .filter(tr => tr.style.display !== "none");
    if (visibles.length === 0) return;

    const botones = generarPaginacion(totalPaginas, paginaActual);

    botones.forEach(num => {
      const btn = document.createElement("button");
      btn.type = "button";

      if (num === "...") {
        btn.textContent = "...";
        btn.disabled = true;
        btn.className = "btn btn-sm btn-secondary";
      } else {
        btn.textContent = num;
        btn.className = "btn btn-sm " + (num === paginaActual ? "btn-primary" : "btn-outline-primary");
        btn.addEventListener("click", () => mostrarPagina(num));
      }

      paginacionDiv.appendChild(btn);
    });
  }

  // Nota: si quieres que al cambiar los filtros se reinicie la paginación,
  // puedes añadir UNA línea al final de tu función aplicarFiltros():
  //    mostrarPagina(1);
</script>


<!--Script para modificar el required del fomulario de carga de archivos-->
<script>
  document.getElementById('btnPublicar').addEventListener('click', function (e) {
    // Eliminar validación obligatoria de archivos al publicar
    document.getElementById('archivoCuadroTurnos').removeAttribute('required');
    document.getElementById('archivoSucesion').removeAttribute('required');
  });
</script>

<!--Script para el Modal editar-->
<script>
  let filaSeleccionada = null;

const camposTurno = [
  "editEstacionIni",
  "editEstacionFin",
  "editHoraIni",
  "editHoraFin",
  "editParticularidades"
];

// Script boton editar de la tabla de datos, este boton abre el modal
document.getElementById("tablaBody").addEventListener("click", (e) => {
  const boton = e.target.closest(".btn-editar");
  if (!boton) return;

  const filaSeleccionada = boton.closest("tr");
  const celdas = filaSeleccionada.querySelectorAll("td");

  document.getElementById("editNombre").value = celdas[0].textContent;
  document.getElementById("editCodigo").value = celdas[1].textContent;
  document.getElementById("editCargo").value  = celdas[3].textContent.trim();
  document.getElementById("editTurno").value  = celdas[2].textContent;
  document.getElementById("editFecha").value  = celdas[4].textContent;
  document.getElementById("editEstacionIni").value = celdas[5].textContent.toUpperCase().trim();
  document.getElementById("editEstacionFin").value = celdas[6].textContent.toUpperCase().trim();
  document.getElementById("editHoraIni").value    = celdas[7].textContent.trim();
  document.getElementById("editHoraFin").value    = celdas[8].textContent.trim();
  document.getElementById("editParticularidades").value = celdas[9].textContent.trim();

  const datosOriginales = {
    nombre: celdas[0].textContent,
    codigo: celdas[1].textContent,
    cargo:  celdas[3].textContent.trim(),
    turno:  celdas[2].textContent,
    fecha:  celdas[4].textContent,
    estacionIni: celdas[5].textContent.trim(),
    estacionFin: celdas[6].textContent.trim(),
    horaIni: celdas[7].textContent,
    horaFin: celdas[8].textContent,
    particularidades: celdas[9].textContent.trim()
  };
  localStorage.setItem("datosOriginales", JSON.stringify(datosOriginales));

  // Deshabilita campos de turno (igual que antes)
  ["editEstacionIni","editEstacionFin","editHoraIni","editHoraFin","editParticularidades"]
    .forEach(id => document.getElementById(id).disabled = true);

  document.getElementById("modalEditar").style.display = "block";
});

document.getElementById("cerrarModal").addEventListener("click", function () {
  document.getElementById("modalEditar").style.display = "none";
  
});

//Script del boton guardar cambios dentro del MOdal, este permite acentar los cambios en el modelo correspondiente, ya sea Empleados o Horario.
document.getElementById("guardarCambios").addEventListener("click", function () {
    const datosOriginales = JSON.parse(localStorage.getItem("datosOriginales") || "{}");
    const diaHoy = hoyBogotaISODate()
    
    const datosNuevos = {
        nombre : document.getElementById("editNombre").value,
        codigo : document.getElementById("editCodigo").value,
        cargo : document.getElementById("editCargo").value,
        turno : document.getElementById("editTurno").value,
        fecha : document.getElementById("editFecha").value,
        estacionIni : document.getElementById("editEstacionIni").value,
        estacionFin : document.getElementById("editEstacionFin").value,
        horaIni : document.getElementById("editHoraIni").value,
        horaFin : document.getElementById("editHoraFin").value,
        particularidades : document.getElementById("editParticularidades").value

    }

    if(datosOriginales.nombre !== datosNuevos.nombre || datosOriginales.codigo !== datosNuevos.codigo || datosOriginales.cargo !== datosNuevos.cargo){
      /*Actualización de datos del empleado*/
      alert("Se modifico el empleado")
      
    }else if(datosOriginales.turno !== datosNuevos.turno || datosOriginales.estacionIni !== datosNuevos.estacionIni 
    || datosOriginales.estacionFin !== datosNuevos.estacionFin || datosOriginales.horaIni !== datosNuevos.horaIni 
    || datosOriginales.horaFin !== datosNuevos.horaFin || datosOriginales.particularidades !== datosNuevos.particularidades){
        //alert("se modifico el turno")
        /*Actualización de datos del turno*/
      if(datosNuevos.turno !== ""){
        if(datosOriginales.fecha < diaHoy){
          document.getElementById("modalEditar").style.display = "none";
            Swal.fire({
                    icon: "error",
                    title: "Modificación no permitida",
                    text: `Solo es posible editar turnos posteriores a la fecha de hoy ${diaHoy}`,
                      })
              return;
        }
          if(datosNuevos.turno !== "COMPE" && datosNuevos.turno !== "LIBRE" && datosNuevos.turno !== "FUNDA" && datosNuevos.turno !== "SUSPEN"){ // SRM548
              if(datosNuevos.estacionIni !== "" && datosNuevos.estacionFin !== "" && datosNuevos.horaIni !== "" && datosNuevos.horaFin !== "" && datosNuevos.particularidades !==  ""){

                fetch("{% url 'actualizar_turno' %}",{
                  method:"POST",
                  headers:{"Content-Type": "application/json",
                          "X-CSRFToken": getCookie("csrftoken")},
                  body: JSON.stringify({
                    turnoOriginal: datosOriginales.turno.toUpperCase(),
                    turno: datosNuevos.turno.toUpperCase(),
                    codigo: datosNuevos.codigo.toUpperCase(),
                    inilugar: datosNuevos.estacionIni.toUpperCase(),
                    finallugar: datosNuevos.estacionFin.toUpperCase(),
                    inihora: datosNuevos.horaIni,
                    finalhora: datosNuevos.horaFin,
                    observaciones: datosNuevos.particularidades.toUpperCase(),
                    peticion: "accesoRapido"
                  })
                })
                .then(response => response.json())
                .then(data => { 
                  Swal.fire({
                    icon: "success",
                    title: "Correcto",
                    text: data.message,
                      }).then(()=>{
                        localStorage.clear();
                        window.location.reload();
                      })
              
                })
                .catch(error => console.error("Error en la actualización"))

              }else{
                  alert("Se dectaron campos vacios en la estación de inicio - final u horas del turno")
              }
            
          }

      }else{
         Swal.fire({
                    icon: "error",
                    title: "Advertencia",
                    text: "Codigo de turno vacio, por favor ingrese un codigo valido"
                    });
      }

    }else{
      Swal.fire({
                    icon: "warning",
                    title: "Advertencia",
                    text: "No se modifico ningun detalle del servicio"
                    });
    }

        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


  document.getElementById("modalEditar").style.display = "none";
});


// Habilitar los campos de detalle del turno-servicio, si el usuario hace clic en el input de turno.
document.getElementById("editTurno").addEventListener("focus", function () {
  camposTurno.forEach(id => {
    document.getElementById(id).disabled = false;
  });
});

// Limpiar campos si el valor es LIBRE o FUNDA
document.getElementById("editTurno").addEventListener("input", function () {
  const turno = this.value.trim().toUpperCase();

  if (["COMPE", "LIBRE", "FUNDA","SUSPEN"].includes(turno)) {
    camposTurno.forEach(id => {
      document.getElementById(id).value = "";
    });
  }else if(["CAF","RECERT"].includes(turno)){
    document.getElementById("editEstacionIni").value = "PBE";
    document.getElementById("editEstacionFin").value = "PBE";
    document.getElementById("editHoraIni").value = "";
    document.getElementById("editHoraFin").value = "";
        if(["CAF"].includes(turno)){
            document.getElementById("editParticularidades").value = "CAPACITACIÓN CAF";
        }else{
            document.getElementById("editParticularidades").value = "RECERTIFICACIÓN";
        }
    
  }
  
});

// Botón cerrar manual desde el boton

 document.getElementById("cerrarBotonManual").addEventListener("click", function () {
    document.getElementById("modalEditar").style.display = "none";
  });

</script>

<!-- Script para el modal Eliminar - Horario -->
 <script>
    function abrirModalHorarios(){

      const modal = document.getElementById("modalHorarios");
      const contenedor = document.getElementById("contenidoHorarios");

      contenedor.innerHTML = "<p> Cargando datos </p>"
    
      modal.style.display = "block"
      
      fetch("{% url 'traer_horarios' %}", {
       /* headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }*/
      })
      .then(response => response.json())
      .then(data => {
        if(data.horarios && data.horarios.length > 0){
        const csrfToken = document.getElementById("csrfTokenGlobal").value;
         const html = `
              <table border="1" cellpadding="6" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th>Nombre Horario</th>
                    <th>Fecha Vigencia</th>
                    <th>Fecha Carga</th>
                    <th>Turnos Cargados</th>
                    <th>Editar</th>
                    <th>Eliminar</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    data.horarios.map(h => ` 
                      <tr>
                        <td>${h.horario}</td>
                        <td>${h.fechavigencia}</td>
                        <td>${h.fecha_carga}</td>
                        <td>${h.numeroDatos}</td>
                        <td>  
                          <form action="/account/editarHorario/" method="POST">
                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                            <input type="hidden" name="horario" value="${h.horario}">
                            <input type="hidden" name="fechavigencia" value="${h.fechavigencia}">
                            <input type="hidden" name="fecha_carga" value="${h.fecha_carga}">
                            <button class="btn-editar" type="submit">Editar</button>
                          </form>
                        </td>
                        <td> <button class="btn-eliminar" onclick="eliminarHorario('${h.horario}', '${h.fechavigencia}', '${h.fecha_carga}')">Eliminar</button> </td>
                        
                      </tr>
                    `).join('')
                    }
                </tbody>
              </table>
            `;
            
            contenedor.innerHTML = html;
        }else{
          contenedor.innerHTML = "<p>No hay horarios recientes.</p>";
        }

      })
      .catch(error => {
      contenedor.innerHTML = "<p>Error al cargar los horarios.</p>";
      console.error(error);
      });

    }

    function eliminarHorario(horario, fechaVigencia,fechaCarga){
    
      fetch("{% url 'eliminar_horario' %}",{
        method : "POST",
        headers : { 'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')},
        body: JSON.stringify({
          'horario': horario,
          'fechavigencia': fechaVigencia,
          'fecha_carga': fechaCarga
        })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success){
          cerrarModalHorarios();
          Swal.fire({
            icon: "success",
            title: "Eliminado",
            text: data.message
        });
        }else{
            cerrarModalHorarios();
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: data.message,
              
            });
        }
      })
      .catch(error => { 
        console.error("Error al eliminar: ", error);
        alert("Existe una relacion");
      })

    }

        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
  function cerrarModalHorarios() {
    document.getElementById("modalHorarios").style.display = "none";
  }
</script>
<!--Script CSRF TOKEN-->
<script>
     function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<!-- DOM Contend loaded-->
 <script>
    document.addEventListener("DOMContentLoaded", () => {

  showLoader(); 
  mostrarDatosProcesados(); 
  setTimeout(mostrarDatosProcesados, 3000); 


  document.getElementById("btnCargar").addEventListener("click", function(){
  showLoader();
  setTimeout(mostrarDatosProcesados, 5000);

  })

  function mostrarDatosProcesados(){
    const procesado = "{{ success }}";
    if(procesado){
      hideLoader();
    }
  }

    function showLoader() {
      document.getElementById("loader-overlay").classList.remove("hidden");
  }

   function hideLoader() {
      document.getElementById("loader-overlay").classList.add("hidden");
    }

    ocultarBotonesCarga();
    aplicarFiltros(); 
    mostrarPagina(1);
    mostrarBotonesCargaTrenes();
    capturarErroresCargaSucesion();
  });

  function mostrarBotonesCargaTrenes(){
      
   document.getElementById("trenes").addEventListener("click", function () {
    const form = document.getElementById("formCargaDatos");
    const filtros = document.querySelectorAll('.filtro');

    // Toggle manual con display
    const isVisible = form.style.display === "block";

    form.style.display = isVisible ? "none" : "block";

    filtros.forEach((elemento) => {
      elemento.style.display = isVisible ? "none" : "block";
    });
});


 document.getElementById("tranvia").addEventListener("click", function () {
    const form = document.getElementById("formCargaDatos");
    const filtros = document.querySelectorAll('.filtro');

    // Toggle manual con display
    const isVisible = form.style.display === "block";

    form.style.display = isVisible ? "none" : "block";

    filtros.forEach((elemento) => {
      elemento.style.display = isVisible ? "none" : "block";
    });
});


  document.getElementById("maniobras").addEventListener("click", function () {
  const form = document.getElementById("formCargaDatos");
  const lunesViernes = document.getElementById('lunesViernes');
  const sabados = document.getElementById('sabados');
  const domingos = document.getElementById('domingos');
  const sucesion = document.getElementById('sucesion');
  const especial = document.getElementById('especial');

  const isVisible = form.style.display === "block";

  // Toggle
  form.style.display = isVisible ? "none" : "block";
  lunesViernes.style.display = isVisible ? "none" : "block";
  sabados.style.display = "none";
  domingos.style.display = "none";
  sucesion.style.display = isVisible ? "none" : "block";
  especial.style.display = "none";
});


 document.getElementById("operadores").addEventListener("click", function () {
  const form = document.getElementById("formCargaDatos");
  const lunesViernes = document.getElementById('lunesViernes');
  const sabados = document.getElementById('sabados');
  const domingos = document.getElementById('domingos');
  const sucesion = document.getElementById('sucesion');
  const especial = document.getElementById('especial');

  const isVisible = form.style.display === "block";

  // Toggle
  form.style.display = isVisible ? "none" : "block";
  lunesViernes.style.display = isVisible ? "none" : "block";
  sabados.style.display = "none";
  domingos.style.display = "none";
  sucesion.style.display = isVisible ? "none" : "block";
  especial.style.display = "none";  
  });
}

  function ocultarBotonesCarga(){

    document.getElementById("formCargaDatos").style.display = "none";
   document.querySelectorAll('.filtro').forEach((elemento)=>{
      elemento.style.display = "none";
    })
  }

  function capturarErroresCargaSucesion(){

   
    const erroresSemana = ('{{ erroresSemana|safe|escapejs }}');
   
    if(erroresSemana !== "None" ){
         Swal.fire({
                    icon: "error",
                    title: "Se detectaron errores al cargar los archivos.",
                    text: erroresSemana.slice(0,150)+ "[ La fecha de vigencia debe estar ubicada en la fila 4, columna 2 ]",
                      })
      }
   
      }
 </script>

<!--Funcion para obtener fecha con horario BOGOTA-->
 <script>
  function hoyBogotaISODate() {
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'America/Bogota',
    year: 'numeric', month: '2-digit', day: '2-digit'
  }).formatToParts(new Date());

  const y = parts.find(p => p.type === 'year').value;
  const m = parts.find(p => p.type === 'month').value;
  const d = parts.find(p => p.type === 'day').value;
  return `${y}-${m}-${d}`; // p.ej. "2025-10-06"
}
 </script>

{% endblock %}
