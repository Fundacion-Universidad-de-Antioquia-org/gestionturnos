{% extends 'base.html' %}
{% load static %}

{% block styles %}
<!--Estilos indicadores-->
<style>
.indicadores {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-right: 15px;
}

.indicador-card.small {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: white;
  background: rgb(40, 36, 36);
  border-radius: 10px;
  padding: 5px 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: transform 0.3s ease;
  white-space: nowrap;
}

.indicador-card.small:hover {
  transform: scale(1.05);
}

/* Spinner inicial */
.indicador-card.small .spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top: 3px solid #1d5031;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Estado final (sin animaci贸n, relleno s贸lido) */
.indicador-card.small .spinner.done {
  animation: none;
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
}

/* Colores */
.total .spinner.done {
  background-color: #007bff;   /* azul */
}
.pendiente .spinner.done {
  background-color: #ffc107;   /* amarillo */
}
.aprobado .spinner.done {
  background-color: #28a745;   /* verde */
}
.desaprobado .spinner.done {
  background-color: #dc3545;   /* rojo */
}
</style>

<!--Estilos para boton respuesta-->
<style>
  .btn-icon {
    border: 0;
    background: transparent;
    cursor: pointer;
    padding: 4px 6px;
  }

  .btn-icon .material-symbols-outlined {
    font-size: 20px;
    color: #1D5031;
  }

  .btn-icon:hover .material-symbols-outlined {
    opacity: .8;
  }
</style>

<!--Estilos para la foto de perfil -->
<style>
.cell-avatar{
  padding: 6px 10px;
  vertical-align: middle;
  text-align: center;
}

/* Tama帽o compacto y look profesional */
.avatar-frame{
  width: 44px;                 /* peque帽o pero legible */
  height: 44px;
  border-radius: 12px;         /* borde redondeado */
  overflow: hidden;            /* recorta el zoom dentro del marco */
  display: inline-block;
  background: #f3f4f6;         /* fallback */
  border: 1px solid #e5e7eb;   /* delineado sutil */
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
}

.avatar-frame img{
  width: 100%;
  height: 100%;
  object-fit: cover;           /* encuadre pro */
  object-position: center;
  transition: transform .25s ease;
}

/* Zoom interno para ver detalle sin crecer el componente */
.avatar-frame:hover img{
  transform: scale(1.08);
}

/* Respeta accesibilidad si el usuario prefiere menos movimiento */
@media (prefers-reduced-motion: reduce){
  .avatar-frame img{ transition: none; }
  .avatar-frame:hover img{ transform: none; }
}

</style>

{% endblock%}
{% block content %}

<section class="usuario-bar-section">
  <div class="usuario-bar position-relative">

<!-- Izquierda: Foto + saludo -->
 <!-- Icono de usuario -->
  <div class="usuario-bar-logo-nombre">
      <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
      <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- T铆tulo de la p谩gina -->
    <div class="saludo" style="color: #ccc; font-size: 11px;">
      Solicitudes GT
    </div>
</div>
  </div>
  
  <div class="indicadores">
  <div class="indicador-card small total">
    <span class="material-symbols-outlined">area_chart</span>
    <div class="spinner"></div>
    <span id="txt-total">Cargando...</span>
  </div>

  <div class="indicador-card small pendiente">
    <div class="spinner"></div>
    <span id="txt-pendiente">Cargando...</span>
  </div>

  <div class="indicador-card small aprobado">
    <div class="spinner"></div>
    <span id="txt-aprobadas">Cargando...</span>
  </div>

  <div class="indicador-card small desaprobado">
    <div class="spinner"></div>
    <span id="txt-rechazadas">Cargando...</span>
  </div>
</div>


  <!-- Derecha -->
  <form action="{% url 'logout' %}" method="post" class="flex-shrink-0">
    {% csrf_token %}
    <button class="btn btn-sm btn-danger" type="submit">Cerrar sesi贸n</button>
  </form>
</div>
</section>


 <!-- Acorde贸n de filtros -->

 <section class="acordion-section">
<div class="accordion-container" style="margin-top: 14px;">
  <div class="accordion-header"><span class="material-symbols-outlined">search</span>Filtros de B煤squeda</div>
  <div class="accordion-body">
    <div class="filtros-horizontal">
       <div class="filtro-item">
        <label for="filtroId">Id solicitud:</label>
        <input type="text" id="filtroId" placeholder="Buscar por id">
      </div>
      <div class="filtro-item">
        <label for="filtroNombre">Nombre:</label>
        <input type="text" id="filtroNombre" placeholder="Buscar por nombre">
      </div>
      <div class="filtro-item">
        <label for="filtroCodigo">C贸digo:</label>
        <input type="text" id="filtroCodigo" placeholder="Buscar por c贸digo">
      </div>
      <div class="filtro-item">
        <label for="filtroCargo">Cargo:</label>
        <select name="select" id="filtroCargo">
            <option value="">Todos</option>
            <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO">CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO</option>
            <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA" >CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA</option>
            <option value="OPERADOR(A) DE CONDUCCION" >OPERADOR(A) DE CONDUCCION</option>
            <option value="MANIOBRISTA TRENES" >MANIOBRISTA TRENES</option>
            <option value="MANIOBRISTA TRANVIA" >MANIOBRISTA TRANVIA</option>
            <option value="INCONSISTENCIA">INCONSISTENCIA</option>
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroTipoSolicitud">Tipo solicitud:</label>
        <select name="select" id="filtroTipoSolicitud">
          <option value="">TODOS</option>
            <option value="VACACIONES">VACACIONES</option>
            <option value="PERMISO ACADEMICO">PERMISO ACADEMICO</option>
            <option value="OTRAS SOLICITUDES">OTRAS SOLICITUDES</option>
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Fecha inicial:</label>
        <input type="date" id="filtroFechaInicial">
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Fecha final:</label>
        <input type="date" id="filtroFechaFinal">
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Estado de solicitud:</label>
        <select name="" id="filtroEstadoSolicitud">
          <option value="">todos</option>
          <option value="pendiente" selected>pendiente</option>
          <option value="aprobado">aprobado</option>
          <option value="desaprobado">desaprobado</option>
        </select>
      </div>
    </div>
  </div>
</div>
</section>

<section class="table-section">
  <table class="styled-table display" id="tablaDatos">
  <thead>
        <tr>
          <th>Foto</th>
          <th>ID Solicitud</th>
            <th>Nombre solicitante</th>
            <th>C贸digo</th>
            <th>Cargo</th>
            <th>Tipo solicitud</th>
            <th>Fecha solicitud</th>
            <th>Fecha inicial</th>
            <th>Fecha final</th>
            <th>Descripci贸n</th>
            <th>Estado</th>
            <th>Respuesta ADM</th>
        </tr>
    </thead>
    <tbody id="tablaBody">
        <tr>
        {% for s in solicitudesGt %}
            <!--<td><img src="{{ s.foto }}" alt="50px" width="50px" style="border-radius: 20px;"></td> -->
          
              <td><img src="{{ s.foto }}" alt="50px" width="60px" style="border-radius: 5px;"></td>
            <td>{{s.id}}</td> 
            <td>{{s.nombre}}</td>
            <td>{{s.codigo}}</td>
            <td>{{s.cargo}}</td>
            <td>{{s.tipo_solicitud}}</td>
            <td>{{s.fecha_solicitud|date:"d/m/Y"}}</td>
            <td><span style="border-radius: 8px; background-color: #f1da05; color: #0b0f12; padding: 7px;">{{s.fecha_inicial|date:"d/m/Y"}}</span></td>
            <td><span style="border-radius: 8px; background-color: #f1da05; color: #0b0f12; padding: 7px;">{{s.fecha_final|date:"d/m/Y"}}</span></td>
             <td>
               <button class="toggle-desc-btn" onclick="abrirModal('{{ s.descripcion|escapejs }}', '{{ s.nombre|escapejs }}', '{{ s.codigo|escapejs }}', '{{ s.tipo_solicitud|escapejs }}', '{{ s.id|escapejs }}', '{{ s.estado|escapejs }}')" style="border-radius: 8px; background-color: #3681c4; color: rgb(250, 250, 250); padding: 7px;"><span class="material-symbols-outlined">content_paste_search</span></button>
             </td> 
             <td><span>{{ s.estado }}</span></td>
             <td>
                <button type="button" class="btn-icon ver-msg" data-title="Respuestas ADM"
            data-msg="{{ s.respuesta|escapejs }}" aria-label="Ver comentarios">
            <span class="material-symbols-outlined" style="color: #2d6fe9; font-size: 35px;">sms</span>
          </button>
             </td>
        </tr>
        {% empty %}s
        <tr>
            <td colspan="12">No hay registros de solicitudes GT</td>
        </tr>

        {% endfor %}

    </tbody>
</table>
</section>

<div id="modalDescripcion" class="modal fade modal-descripcion-profesional">
  <div class="modal-dialog">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h3 class="modal-header-custom-dos">Descripci贸n de la Solicitud </h3>
      <p><strong>Id solicitud</strong></p><p id="idSolicitud"></p>
      <p><strong>Tipo solicitud</strong></p><p id="tipoSolicitud"></p>
      <p><strong>Empleado </Strong></p><p id="nombreEmpleado" class="modal-texto"></p>
      <p><strong>C贸digo</strong></p><p id="codigoEmpleado" class="modal-texto"></p>
      <p><strong>Estado</strong></p><p id="estadoSolicitud" class="modal-texto"></p>
      <br>
      <p><strong>Descripci贸n</strong></p>
      <p id="contenidoDescripcion" class="modal-texto"></p>
      <button class="btn-fourth"  id="btnVerAdjunto">硷Ver adjunto</button>
       <button class="btn-third" id="respuestaSolicitud">Respuesta </button>
      <button class="btn-third" id="aprobarSolicitud">锔Aprobar</button>
      <button class="btn-secondary" id="desaprobarSolicitud">Desaprobar</button>
      <div class="modal-content" id="campoRespuesta" style="display: none;">
        <textarea name="" id="respuesta" cols="64" rows="5" ></textarea>
        <button class="btn-third" id="guardarRespuesta">Guardar respuesta</button>
      </div>
      
    </div>
  </div>
</div>

<!-- MODAL VISOR (para PDF/imagen a tama帽o grande) -->
<div id="modalVisorArchivo" aria-modal="true" role="dialog">
  <div class="visor-dialog">
    <div class="visor-content">
      <button type="button" class="visor-close" aria-label="Cerrar" onclick="cerrarModalVisor()">&times;</button>

      <div class="visor-header">
        <a id="visorLink" href="#" target="_blank" rel="noopener noreferrer"><span class="material-symbols-outlined">ads_click</span>Click aqui par abrir en pesta帽a nueva</a>
      </div>

      <div id="visorBody" class="visor-body">
        <!-- aqu铆 se inyecta iframe o img -->
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Funci贸n para actualizar un indicador
function actualizarIndicador(clase, idTexto, valor, etiqueta) {
  const spinner = document.querySelector(`.${clase} .spinner`);
  spinner.classList.add("done"); //  detiene animaci贸n y aplica color
  document.getElementById(idTexto).textContent = `${valor} ${etiqueta}`;
}

// Al obtener datos (ejemplo simulado con setTimeout)
setTimeout(() => {
  /*actualizarIndicador("total", "txt-total", indicadores.total, "Solicitudes");*/
  actualizarIndicador("pendiente", "txt-pendiente", indicadores.pendiente, "Pendientes");
  actualizarIndicador("aprobado", "txt-aprobadas", indicadores.aprobadas, "Aprobadas");
  actualizarIndicador("desaprobado", "txt-rechazadas", indicadores.rechazadas, "Rechazadas");
}, 2000); // simula carga en 2s

</script>

<!--Script del DOM-->
<script>
  document.addEventListener("DOMContentLoaded",function(){
    // Ejemplo con valores desde backend

    const solicitudAnual = "{{ solicitudAnual }}"
    const solicitudAnualAprobadas = "{{ solicitudAnualAprobadas }}"
    const solicitudAnualPendientes = "{{ solicitudAnualPendientes }}"
    const solicitudAnualDesaprobadas = "{{ solicitudAnualDesaprobadas }}"

    setTimeout(()=>{
      actualizarIndicador("total", "txt-total", solicitudAnual, "Solicitudes");
      actualizarIndicador("aprobado", "txt-aprobadas", solicitudAnualAprobadas, "Aprobadas");
      actualizarIndicador("pendiente", "txt-pendiente", solicitudAnualPendientes, "Pendientes");
      actualizarIndicador("desaprobado", "txt-rechazadas", solicitudAnualDesaprobadas, "Rechazadas");
    }, 2000);
    
    
    /*animateValue("solicitudesAnuales", 0, solicitudAnual, 1500);
    animateValue("solicitudesAprobadas", 0, solicitudAnualAprobadas, 1500);
    animateValue("solicitudesDesaprobadas", 0, solicitudAnualDesaprobadas, 1500);*/

    aplicarFiltros();

    const cargaSolicitudes = "{{ mensaje|escapejs }}"

    if(cargaSolicitudes != ""){
        Swal.fire({
            icon: "success",
            title: "Se cargaron correctamente los resultados",
            text: cargaSolicitudes
        });
    }else{
      Swal.fire({
            icon: "success",
            title: "No encontraron resultados para la busqueda",
            text: cargaSolicitudes
        });
    }
  
  })

</script>

<!--Agregar estilos al span - estado de la tabla -->
<script>

  const estado = "pendiente";
  const indiceColumna = 9;
  const filas = document.querySelectorAll("#tablaDatos tr")

  filas.forEach((fila, index )=>{
      if(index === 0) return;

      const celda = fila.cells[indiceColumna];

      if (celda) {
      const span = celda.querySelector("span"); 
      if (span && span.textContent.trim() === "pendiente") {
        
        span.style.backgroundColor = "#f1da05";
        span.style.color = "black";
        span.style.padding = "7px"; 
        span.style.borderRadius = "8px"; 
      }
    }
      
  })
</script>
<!--Script para el boton de aprobar y desaprobar la solicitud GT-->
<script>

  document.getElementById("aprobarSolicitud").addEventListener("click",function(){
      const idSolicitud = document.getElementById("idSolicitud").textContent
      const estado = "aprobado" 
      gestionarSolicitud(idSolicitud, estado)
  })

  document.getElementById("desaprobarSolicitud").addEventListener("click",function(){
    const idSolicitud = document.getElementById("idSolicitud").textContent
    const estado = "desaprobado" 
    gestionarSolicitud(idSolicitud, estado)
  })

  function gestionarSolicitud(idSolicitud, estado){
       
        fetch("{% url 'gestionarSolicitudeGt' %}",{
          method: "POST",
          headers:{"Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken")},
          body: JSON.stringify({
            "idSolicitud": idSolicitud,
            "estadoSolicitud": estado
          })
          })
          .then(response => response.json())
          .then(data => {
            if(data.success){
              const modal = document.getElementById("modalDescripcion");
              modal.classList.remove("show");
              Swal.fire({
                    icon: "success",
                    title: "Correcto",
                    text: data.message,
                      }).then(()=>{
                        window.location.reload();
                      })

            }else{
              Swal.fire({
                    icon: "error",
                    title: "OOps courrio un error al aprobar la solicitud",
                    text: data.message,
                      }).then(()=>{
                        window.location.reload();
                      })
            }
          })
        }
</script>


<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const btn = document.getElementById('btnVerAdjunto');
  btn?.addEventListener('click', abrirVisorDesdeSolicitud);
  // Cerrar con click afuera
  document.getElementById('modalVisorArchivo').addEventListener('click', (e) => {
    if (e.target.id === 'modalVisorArchivo') cerrarModalVisor();
  });
  // Cerrar con ESC
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') cerrarModalVisor(); });
});

async function abrirVisorDesdeSolicitud() {

  const id = document.getElementById('idSolicitud')?.textContent.trim();
  if (!id) { alert('No hay idSolicitud en el modal.'); return; }

  
  const base = "{% url 'get_archivosgt' %}";
  const urlApi = `${base}?idSolicitud=${encodeURIComponent(id)}`;

  try {
    const res = await fetch(urlApi, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { success, url, tipoArchivo } = await res.json();
    if (!success || !url) { 
      const modal = document.getElementById("modalDescripcion");
      modal.classList.remove("show"); 
        Swal.fire({
            icon: "error",
            title: "No hay archivos cargados",
        })
    }

    abrirModalVisor(url,tipoArchivo);
  } catch (err) {
    console.error(err);
      Swal.fire({
            icon: "error",
            title: "No hay archivos cargados",
        })
  }
}

function abrirModalVisor(fileUrl, tipoArchivo) {
  
  const visor = document.getElementById('modalVisorArchivo');
  const link = document.getElementById('visorLink');
  const body = document.getElementById('visorBody');
  const IMG_EXT_RE = /^\.(?:avif|webp|png|gif|jpe?g|jfif|pjpeg|pjp|bmp|svg|ico|cur)$/i;

  link.href = fileUrl;
  body.innerHTML = ''; // limpia

  // Intento de mostrar: si termina en .pdf, iframe; si es imagen, <img>;
  // si no tiene extensi贸n, probamos imagen y si falla, iframe.
  const lower = fileUrl.toLowerCase();

  if (tipoArchivo === ".pdf") {
    body.innerHTML = `<iframe src="${fileUrl}" width="100%" height="600px" style="border:none;"></iframe>`;
  } else if (IMG_EXT_RE.test(tipoArchivo)) {
    body.innerHTML = `<img src="${fileUrl}" alt="archivo" style="max-width:100%; height:auto;">`;
  } else {
    body.innerHTML = `
      <img src="https://www.entresistemas.com/wp-content/uploads/Microsoft-Word-Logo-2048x2048.png" alt="" width="300px">
      <h1>★ Si es un archivo de Word (.docx) da click arriba para abrir en otra pesta帽a </h1>
    `;
  }


  visor.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function cerrarModalVisor() {
  const visor = document.getElementById('modalVisorArchivo');
  visor.classList.remove('show');
  document.body.style.overflow = '';
  // opcional: limpiar contenido para liberar memoria
  document.getElementById('visorBody').innerHTML = '';
}
</script>

<!--Script para el modal de descripcion de la solicitud-->
 <script>
  function abrirModal(descripcion, nombre, codigo, tipoSolicitud, id, estado) {
    const modal = document.getElementById("modalDescripcion");
    document.getElementById("nombreEmpleado").innerText = nombre;
    document.getElementById("codigoEmpleado").innerText = codigo;
    document.getElementById("tipoSolicitud").innerText = tipoSolicitud;
    document.getElementById("idSolicitud").innerText = id;
    document.getElementById("estadoSolicitud").innerText = estado;
    document.getElementById("contenidoDescripcion").innerText = descripcion;
    modal.classList.add("show");
  }

  function cerrarModal() {
    document.getElementById("campoRespuesta").style.display  = "none";
    const modal = document.getElementById("modalDescripcion");
    modal.classList.remove("show");
    // Esperar la transici贸n antes de ocultar del DOM
    setTimeout(() => {
      modal.style.display = "none";
    }, 300);
  }

  // Cierra si se hace clic fuera del contenido
  window.addEventListener('click', function (e) {
    const modal = document.getElementById("modalDescripcion");
    const content = modal.querySelector('.modal-content');
    if (e.target === modal) {
      cerrarModal();
    }
  });

  // Asegura display:block cuando se agrega clase show
  const observer = new MutationObserver(() => {
    const modal = document.getElementById("modalDescripcion");
    if (modal.classList.contains("show")) {
      modal.style.display = "block";
    }
  });
  observer.observe(document.getElementById("modalDescripcion"), { attributes: true });

    document.getElementById("respuestaSolicitud").addEventListener("click",function(){
    campoRespuesta = document.getElementById("campoRespuesta")

    if (campoRespuesta.style.display === "none" || campoRespuesta.style.display === "" ){
      campoRespuesta.style.display = "block";
    }else{
      campoRespuesta.style.display = "none";
    }
  })

  document.getElementById("guardarRespuesta").addEventListener("click",function(){

    respuesta = document.getElementById("respuesta").value
    idSolicitudGt = document.getElementById("idSolicitud").textContent

    alert("id: "+ idSolicitudGt+ " respuesta: "+respuesta)

    if(respuesta !== ""){

      fetch("{% url 'insertarRespuesta' %}",{
      method: "POST",
      headers:{"Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken")},
      body: JSON.stringify({
        "idSolicitudGt": idSolicitudGt,
        "respuesta": respuesta
      })
    })
    .then(response => response.json())
    .then(data => {
      if(data.success){
        cerrarModal();
        Swal.fire({
            icon: "success",
            title: "Correcto",
            text: "Se envio correctamente tu respuesta"
          
        });
      }else{
        cerrarModal();
        Swal.fire({
            icon: "error",
            title: "Se detectaron un error al enviar la respuesta",


          
        });
      }
    })
    }else{
      cerrarModal();
      Swal.fire({
            icon: "error",
            title: "Se detectaron campos vacios",
          
        });
    }
    

  })



</script>

<!--Script filtros-->
<script>
  // Acorde贸n toggle
    document.querySelectorAll('.accordion-header').forEach(hdr => {
      hdr.addEventListener('click', () => {
        hdr.classList.toggle('active');
        const body = hdr.nextElementSibling;
        body.classList.toggle('active');
      });
    });


  // Elementos de filtro
  const filtros = {
    id: document.getElementById('filtroId'),
    nombre: document.getElementById('filtroNombre'),
    codigo: document.getElementById('filtroCodigo'),
    cargo: document.getElementById('filtroCargo'),
    tipoSolicitud : document.getElementById('filtroTipoSolicitud'),
    fechaInicial: document.getElementById('filtroFechaInicial'),
    fechaFinal: document.getElementById('filtroFechaFinal'),
    estado: document.getElementById('filtroEstadoSolicitud'),
  };

  // Asignar eventos
  Object.values(filtros).forEach(input => {
    input.addEventListener('input', aplicarFiltros);
    input.addEventListener('change', aplicarFiltros);
  });
function aplicarFiltros() {
  const valorId = filtros.id.value.toLowerCase().trim();
  const valorNombre = filtros.nombre.value.toLowerCase().trim();
  const valorCodigo = filtros.codigo.value.toLowerCase().trim();
  const valorCargo = filtros.cargo.value.toLowerCase().trim(); 
  const valorTipoSolicitud = filtros.tipoSolicitud.value.toLowerCase().trim();
  const valorFechaInicial = filtros.fechaInicial.value;
  const valorFechaFinal = filtros.fechaFinal.value;
  const valorEstado = filtros.estado.value;

  document.querySelectorAll('#tablaDatos tbody tr').forEach(row => {
    const tId = row.cells[1].textContent.toLowerCase().trim();
    const tNombre = row.cells[2].textContent.toLowerCase().trim();
    const tCodigo = row.cells[3].textContent.toLowerCase().trim();
    const tCargo = row.cells[4].textContent.toLowerCase().trim(); 
    const tTipoSolicitud = row.cells[5].textContent.toLowerCase().trim();
    const tFechaInicial = row.cells[7].textContent.trim();
    const tFechaFinal = row.cells[8].textContent.trim();
    const tEstado = row.cells[10].textContent.toLowerCase().trim();

    const coincideId = !valorId || tId === valorId;
    const coincideNombre = !valorNombre || tNombre.includes(valorNombre);
    const coincideCodigo = !valorCodigo || tCodigo === valorCodigo;
    const coincideCargo = !valorCargo || tCargo === valorCargo;
    const coincideSolicitud = !valorTipoSolicitud || tTipoSolicitud === valorTipoSolicitud;
    

    const fechaInicialFiltro = valorFechaInicial ? new Date(valorFechaInicial) : null;
    const fechaFinalFiltro = valorFechaFinal ? new Date(valorFechaFinal) : null;
    const fechaInicialDato = new Date(formatoFechaDMYaISO(tFechaInicial));
    const fechaFinalDato = new Date(formatoFechaDMYaISO(tFechaFinal));

    const coincideEstado = !valorEstado || tEstado === valorEstado;

    const coincideRangoFechas = (!fechaInicialFiltro || fechaInicialDato >= fechaInicialFiltro) &&
                                (!fechaFinalFiltro || fechaFinalDato <= fechaFinalFiltro);

    row.style.display = (coincideNombre && coincideCodigo && coincideCargo && coincideSolicitud && coincideRangoFechas && coincideEstado && coincideId) ? '' : 'none';
  });
}

function formatoFechaDMYaISO(fechaDMY) {
  const [dia, mes, anio] = fechaDMY.split('/');
  return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
}

</script>

</script>

<!--Script para escapear el comentario que llega del back-->
<script>
  (function () {
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Convierte "\u000A" y "\n" literales en saltos reales
    function decodeNewlines(s) {
      if (!s) return '';
      return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n').replace(/\r\n/g, '\n');
    }

    document.getElementById('tablaBody').addEventListener('click', e => {
      const btn = e.target.closest('.ver-msg');
      if (!btn) return;

      const title = btn.dataset.title || 'Mensaje';
      const decoded = decodeNewlines(btn.dataset.msg || '');

      Swal.fire({
        title: title,
        html: `<div style="text-align:left; font-size:15px; white-space:pre-wrap; max-height:60vh; overflow:auto;"> <span class="material-symbols-outlined">server_person</span>${escapeHtml(decoded)}</div>`,
        width: 700,
        confirmButtonText: 'Cerrar'
      });
    });
  })();

</script>

{% endblock %}