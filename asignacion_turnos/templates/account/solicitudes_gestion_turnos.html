{% extends 'base.html' %}
{% load static %}

{% block styles %}

<style>
  .swal2-container { z-index: 100000 !important; }

  /* transici√≥n elegante al retirar una fila */
#tablaDatos tbody tr {
  will-change: transform, opacity, filter;
}

#tablaDatos tbody tr.fade-out {
  animation: row-leave .34s cubic-bezier(.2,.8,.2,1) forwards;
}

/* colabora para que no ‚Äúsalte‚Äù la altura visual mientras se va */
#tablaDatos tbody tr.fade-out td {
  transition: padding .22s ease, border-color .22s ease;
  padding-top: 4px !important;
  padding-bottom: 4px !important;
  border-color: rgba(255,255,255,.08) !important;
}

@keyframes row-leave {
  0%   { opacity: 1; transform: translateY(0) scale(1);    filter: blur(0); }
  60%  { opacity: .45; transform: translateY(-2px) scale(.995); filter: blur(.4px); }
  100% { opacity: 0; transform: translateY(-6px) scale(.985);  filter: blur(.8px); }
}

/* respeto a accesibilidad */
@media (prefers-reduced-motion: reduce) {
  #tablaDatos tbody tr.fade-out { animation: none; opacity: 0; }
}


</style>
<!--Estilos indicadores-->
<style>
.indicadores {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-right: 15px;
}

.indicador-card.small {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: white;
  background: rgb(40, 36, 36);
  border-radius: 10px;
  padding: 5px 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: transform 0.3s ease;
  white-space: nowrap;
}

.indicador-card.small:hover {
  transform: scale(1.05);
}

/* Spinner inicial */
.indicador-card.small .spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.3);
  border-top: 3px solid #1d5031;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Estado final (sin animaci√≥n, relleno s√≥lido) */
.indicador-card.small .spinner.done {
  animation: none;
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
}

/* Colores */
.total .spinner.done {
  background-color: #007bff;   /* azul */
}
.pendiente .spinner.done {
  background-color: #ffc107;   /* amarillo */
}
.aprobado .spinner.done {
  background-color: #28a745;   /* verde */
}
.desaprobado .spinner.done {
  background-color: #dc3545;   /* rojo */
}
</style>

<!--Estilos para boton respuesta-->
<style>
.btn-icon {
  border: 0;
  color: #2d6fe9;
  background: transparent;
  cursor: pointer;
  padding: 4px 6px;
  transition: transform 150ms ease;   /* transici√≥n suave */
}

.btn-icon:hover {
  transform: scale(1.35);
            /* crece ~8% al hover */
}

.btn-icon .material-symbols-outlined {
  font-size: 35px;
}


</style>

<!--Modal descripcion-->
<style>
  /* Backdrop con blur */
  .modal-backdrop{
    position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
    background: rgba(9,12,16,.35);
    -webkit-backdrop-filter: blur(10px) saturate(130%);
    backdrop-filter: blur(10px) saturate(130%);
    opacity:0; pointer-events:none; transition:opacity .18s ease;
  }
  .modal-backdrop[aria-hidden="false"]{ opacity:1; pointer-events:auto; }

  .modal-container{
    width:min(900px, 96vw); max-height:88vh; overflow:hidden;
    border-radius:14px; background:#0e1520; color:#e6eef8;
    border:1px solid rgba(255,255,255,.07); box-shadow:0 12px 36px rgba(0,0,0,.45);
    transform: translateY(8px) scale(.98); opacity:0;
    transition: transform .22s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
  }
  .modal-backdrop[aria-hidden="false"] .modal-container{ transform:none; opacity:1; }
  .modal-header, .modal-footer{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px 16px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    border-bottom:1px solid rgba(255,255,255,.07);
  }
  .modal-footer{ border-top:1px solid rgba(255,255,255,.07); border-bottom:0; }
  .modal-body{ padding:12px 16px; max-height: calc(88vh - 120px); overflow:auto; }

  .icon-btn{ border:0; background:transparent; color:#e6eef8; width:36px; height:36px; border-radius:10px; cursor:pointer; }
  .icon-btn:hover{ background:#1a2430; }

  /* Tabla */
  .table-wrap{ width:100%; overflow:auto; }
  .tbl{ width:100%; border-collapse:collapse; font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .tbl thead th{
    text-align:left; font-weight:600; color:#b9c7d6; position:sticky; top:0; z-index:1;
    background:#101827; padding:10px 12px; border-bottom:1px solid #263445;
  }
  .tbl tbody td{ padding:10px 12px; border-bottom:1px solid #1e293b; vertical-align:top; }
  .tbl tbody tr:hover td{ background:#0f172a; }
  .tbl td .muted{ color:#8ea4b8; font-size:12px; }
  .tbl td .msg{ white-space:pre-wrap; word-break:break-word; }

  .btn-secondary{
    border:0; border-radius:10px; padding:10px 14px; cursor:pointer;
    background:#1a2430; color:#e6eef8;
  }
  .btn-secondary:hover{ background:#1e2a38; }
</style>


{% endblock%}
{% block content %}

<section class="usuario-bar-section">
  <div class="usuario-bar position-relative">

<!-- Izquierda: Foto + saludo -->
 <!-- Icono de usuario -->
  <div class="usuario-bar-logo-nombre">
      <span class="material-symbols-outlined mb-1" style="color: white; font-size: 46px;">account_circle</span>
      <div class="d-flex flex-column align-items-center flex-shrink-0">
  
    <!-- Nombre del usuario -->
    <div class="saludo" style="color: white; font-weight: 500;">
      {{ usuarioLogeado }}
    </div>

    <!-- T√≠tulo de la p√°gina -->
    <div class="saludo" style="color: #5a9138; font-size: 11px;">Solicitudes GT</div>
    
  </div>
   <div class="usuario-bar-centro">
    <button title="Buscar solicitud por codigo | fecha" id="btnBuscarSolicitud" ><span class="material-symbols-outlined">search</span></button>
    <button id="generarInformeGestion" title="Generar informe GT-Solicitudes"><span class="material-symbols-outlined">download</span></button>
    <button id="generarDashboard"><span class="material-symbols-outlined">bar_chart_4_bars</span></button>
    <button id="informeVacaciones" title="Reporte de vacaciones"><span class="material-symbols-outlined">chair_umbrella</span></button>
    
  </div>
  </div>
  
  <div class="indicadores">
  <div class="indicador-card small total">
    <div class="spinner"></div>
    <span id="txt-total">Cargando...</span>
  </div>

  <div class="indicador-card small pendiente">
    <div class="spinner"></div>
    <span id="txt-pendiente">Cargando...</span>
  </div>

  <div class="indicador-card small aprobado">
    <div class="spinner"></div>
    <span id="txt-aprobadas">Cargando...</span>
  </div>

  <div class="indicador-card small desaprobado">
    <div class="spinner"></div>
    <span id="txt-rechazadas">Cargando...</span>
  </div>
</div>

  <!-- Derecha -->
  <form action="{% url 'logout' %}" method="post" class="flex-shrink-0">
    {% csrf_token %}
    <button class="btn btn-sm btn-danger" type="submit">Cerrar sesi√≥n</button>
  </form>
</div>
</section>

<!--Variables que llegan con el render -->
{{ mensaje|json_script:"mensaje-json" }}

 <!-- Acorde√≥n de filtros -->
 <section class="acordion-section">
<div class="accordion-container" style="margin-top: 14px;">
  <div class="accordion-header"><span class="material-symbols-outlined">filter_alt</span>Filtros de B√∫squeda</div>
  <div class="accordion-body">
    <div class="filtros-horizontal">
       <div class="filtro-item">
        <label for="filtroId">Id solicitud:</label>
        <input type="text" id="filtroId" placeholder="Buscar por id">
      </div>
      <div class="filtro-item">
        <label for="filtroNombre">Nombre:</label>
        <input type="text" id="filtroNombre" placeholder="Buscar por nombre">
      </div>
      <div class="filtro-item">
        <label for="filtroCodigo">C√≥digo:</label>
        <input type="text" id="filtroCodigo" placeholder="Buscar por c√≥digo">
      </div>
      <div class="filtro-item">
        <label for="filtroCargo">Cargo:</label>
        <select name="select" id="filtroCargo">
            <option value="">Todos</option>
            <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO">CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO METRO</option>
            <option value="CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA" >CONDUCTOR(A) DE VEHICULOS DE PASAJEROS TIPO TRANVIA</option>
            <option value="OPERADOR(A) DE CONDUCCION" >OPERADOR(A) DE CONDUCCION</option>
            <option value="MANIOBRISTA TRENES" >MANIOBRISTA TRENES</option>
            <option value="MANIOBRISTA TRANVIA" >MANIOBRISTA TRANVIA</option>
            <option value="INCONSISTENCIA">INCONSISTENCIA</option>
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroTipoSolicitud">Tipo solicitud:</label>
        <select name="select" id="filtroTipoSolicitud">
          <option value="">TODOS</option>
            <option value="VACACIONES">VACACIONES</option>
            <option value="PERMISO ACADEMICO">PERMISO ACADEMICO</option>
            <option value="OTRAS SOLICITUDES">OTRAS SOLICITUDES</option>
        </select>
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Fecha inicial:</label>
        <input type="date" id="filtroFechaInicial">
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Fecha final:</label>
        <input type="date" id="filtroFechaFinal">
      </div>
      <div class="filtro-item">
        <label for="filtroFecha">Estado de solicitud:</label>
        <select name="" id="filtroEstadoSolicitud">
          <option value="">todos</option>
          <option value="pendiente" selected>pendiente</option>
          <option value="aprobado">aprobado</option>
          <option value="desaprobado">desaprobado</option>
        </select>
      </div>
    </div>
  </div>
</div>
</section>
<section class="table-section"><table class="styled-table display" id="tablaDatos">
<thead>
        <tr>
          <th>Foto</th>
          <th>ID Solicitud</th>
            <th>Nombre solicitante</th>
            <th>C√≥digo</th>
            <th>Cargo</th>
            <th>Tipo solicitud</th>
            <th>Fecha solicitud</th>
            <th>Fecha inicial</th>
            <th>Fecha final</th>
            <th>Estado</th>
            <th>Descripci√≥n</th>
            <th>Respuesta ADM</th>
        </tr>
    </thead>
    <tbody id="tablaBody">
        {% for s in solicitudesGt %}
          <tr>
            <td><img src="{{ s.empleado.foto }}" alt="50px" width="60px" style="border-radius: 5px;"></td>
            <td>{{s.id}}</td> 
            <td>{{s.empleado.nombre}}</td>
            <td>{{s.empleado.codigo}}</td>
            <td>{{s.cargo}}</td>
            <td>{{s.tipo_solicitud}}</td>
            <td>{{s.fecha_solicitud|date:"d/m/Y"}}</td>
            <td>{{s.fecha_inicial|date:"d/m/Y"}}</td> <!--<span style="border-radius: 8px; background-color: #f1da05; color: #0b0f12; padding: 7px;">-->
            <td>{{s.fecha_final|date:"d/m/Y"}}</td>
            <td><span>{{ s.estado }}</span></td>
             <td>
               <button class="btn-ver-respuesta btn-icon" onclick="abrirModal('{{ s.descripcion|escapejs }}', '{{ s.empleado.nombre|escapejs }}', '{{ s.empleado.codigo|escapejs }}', '{{ s.tipo_solicitud|escapejs }}', '{{ s.id|escapejs }}', '{{ s.estado|escapejs }}')"><span class="material-symbols-outlined">content_paste_search</span></button>
             </td> 
             
             <td>
                <button type="button" class="btn-ver-respuesta btn-icon" data-id="{{ s.id }}"> <span class="material-symbols-outlined">sms</span></button>
             </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="12">No hay registros de solicitudes GT</td>
        </tr>

        {% endfor %}

    </tbody>
</table>
</section>

<div id="modalDescripcion" class="modal fade modal-descripcion-profesional">
  <div class="modal-dialog">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <h3 class="modal-header-custom-dos">Descripci√≥n de la Solicitud </h3>
      <p><strong>Id solicitud</strong></p><p id="idSolicitud"></p>
      <p><strong>Tipo solicitud</strong></p><p id="tipoSolicitud"></p>
      <p><strong>Empleado </Strong></p><p id="nombreEmpleado" class="modal-texto"></p>
      <p><strong>C√≥digo</strong></p><p id="codigoEmpleado" class="modal-texto"></p>
      <p><strong>Estado</strong></p><p id="estadoSolicitud" class="modal-texto"></p>
      <br>
      <p><strong>Descripci√≥n</strong></p>
      <p id="contenidoDescripcion" class="modal-texto"></p>
      <button class="btn-fourth"  id="btnVerAdjunto">üñºÔ∏èVer adjunto</button>
       <button class="btn-third" id="respuestaSolicitud">üìëRespuesta </button>
      <button class="btn-third" id="aprobarSolicitud">‚úîÔ∏èAprobar</button>
      <button class="btn-secondary" id="desaprobarSolicitud">‚ùåDesaprobar</button>
      <div class="modal-content" id="campoRespuesta" style="display: none;">
        <textarea name="" id="respuesta" cols="64" rows="5" ></textarea>
        <button class="btn-third" id="guardarRespuesta">Guardar respuesta</button>
      </div>
      
    </div>
  </div>
</div>

<!-- MODAL VISOR (para PDF/imagen a tama√±o grande) -->
<div id="modalVisorArchivo" aria-modal="true" role="dialog">
  <div class="visor-dialog">
    <div class="visor-content">
      <button type="button" class="visor-close" aria-label="Cerrar" onclick="cerrarModalVisor()">&times;</button>

      <div class="visor-header">
        <a id="visorLink" href="#" target="_blank" rel="noopener noreferrer"><span class="material-symbols-outlined">ads_click</span>Click aqui par abrir en pesta√±a nueva</a>
      </div>

      <div id="visorBody" class="visor-body">
        <!-- aqu√≠ se inyecta iframe o img -->
      </div>
    </div>
  </div>
</div>

<!-- Modal Respuestas-ADM -->
<div class="modal-backdrop" id="modal-respuestas" aria-hidden="true">
  <div class="modal-container" role="dialog" aria-modal="true" aria-labelledby="mr-title" tabindex="-1">
    <header class="modal-header">
      <h3 id="mr-title">Respuestas</h3>
      <button class="icon-btn" aria-label="Cerrar" data-modal-close>‚úï</button>
    </header>

    <div class="modal-body">
      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th style="width: 160px;">ID Solicitud</th>
              <th >Respuesta</th>
              <th style="width: 160px;">Fecha</th>
            </tr>
          </thead>
          <tbody id="mr-tbody">
            
          </tbody>
        </table>
      </div>
    </div>

    <footer class="modal-footer">
      <button class="btn-secondary" data-modal-close>Cerrar</button>
    </footer>
  </div>
</div>

<!--Modal informe GT-Solicitudes -->
<div id="modalInformeGT" class="modal-fechas-gt">
  <div class="modal-fechas-gt-contenido">
    <span class="cerrar-fechas-gt" onclick="cerrarModalInformeGT()">&times;</span>

    <div class="icon-title"><span class="material-symbols-outlined">download</span><h3 class="titulo-fechas-gt">Descarga de datos</h3></div>
    <div class="formulario-fechas-gt">
      <label for="fechaInicioGT">Fecha inicial:</label>
      <input type="date" id="fechaInicioGTX" class="input-fechas-gt">

      <label for="fechaFinGT">Fecha final:</label>
      <input type="date" id="fechaFinGTX" class="input-fechas-gt">

       <label for="">Tipo de solicitud</label>
      <select name="" id="opcionTipoSolicitud" class="input-fechas-gt">
        <option value="todo">Todas</option>
        <option value="PERMISO ACADEMICO">Academicas</option>
        <option value="PERMISO PERSONAL">Personales</option>
      </select>

      <label for="">Estado de la solicitud</label>
      <select name="" id="opcionEstado" class="input-fechas-gt">
        <option value="todo">Todas</option>
        <option value="pendiente">Pendientes</option>
        <option value="aprobado">Aprobados</option>
        <option value="desaprobado">Desaprobados</option>
      </select>

      <button class="btn-cargar-fechas-gt" id="descargarInforme">Descargar</button>
    </div>
  </div>
</div>

<!--Modal dashboard -->
<div id="modalDashboard" class="modal-fechas-gt">
  <div class="modal-fechas-gt-contenido">
    <span class="cerrar-fechas-gt" onclick="cerrarModalDashboard()">&times;</span>
    <div class="icon-title"><span class="material-symbols-outlined">pie_chart</span><h3 class="titulo-fechas-gt">Dashboard</h3></div>

    <div class="formulario-fechas-gt">
      <label for="fechaInicioGT">Fecha inicial:</label>
      <input type="date" id="fechaInicioDash" class="input-fechas-gt">

      <label for="fechaFinGT">Fecha final:</label>
      <input type="date" id="fechaFinDash" class="input-fechas-gt">

      <label for="">Generar dashboard por:</label>
      <select name="" id="opcionEstadoDash" class="input-fechas-gt">
        <option value="academica">Acad√©micas</option>
        <option value="personal">Personales</option>
      </select>

      <button class="btn-cargar-fechas-gt" id="cargarDashboard">Generar</button>

<div class="modal-buscarSucesion" id="modalBuscarSolicitud">
  <div class="modal-buscarSucesion-contenido">
    <span class="cerrar-buscarSucesion" onclick="cerrarModalBuscarSolicitud()">&times;</span>
    <div class="icon-title"><span class="material-symbols-outlined">search</span><h3 class="titulo-buscarSucesion">Buscar solicitud</h3></div>

    <div class="formulario-buscarSucesion">
      <label for="codigo">C√≥digo:</label>
      <input type="text" id="buscarCodigoSolicitud" class="input-buscarSucesion">

      <label for="codigo">Id solicitud:</label>
      <input type="text" id="buscarIdSolicitud" class="input-buscarSucesion">

      <button class="btn-cargar-buscarSucesion" id="btnCargarSolicitud">Buscar</button>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Funci√≥n para actualizar un indicador
function actualizarIndicador(clase, idTexto, valor, etiqueta) {
  const spinner = document.querySelector(`.${clase} .spinner`);
  spinner.classList.add("done"); // üîπ detiene animaci√≥n y aplica color
  document.getElementById(idTexto).textContent = `${valor} ${etiqueta}`;
}

</script>

<!--Script del DOM-->
<script>
  document.addEventListener("DOMContentLoaded",function(){
    
    const solicitudAnual = "{{ solicitudAnual }}"
    const solicitudAnualAprobadas = "{{ solicitudAnualAprobadas }}"
    const solicitudAnualPendientes = "{{ solicitudAnualPendientes }}"
    const solicitudAnualDesaprobadas = "{{ solicitudAnualDesaprobadas }}"
    const cargaSolicitudes = JSON.parse(document.getElementById('mensaje-json').textContent)

    setTimeout(()=>{
      actualizarIndicador("total", "txt-total", solicitudAnual, "Solicitudes");
      actualizarIndicador("aprobado", "txt-aprobadas", solicitudAnualAprobadas, "Aprobadas");
      actualizarIndicador("pendiente", "txt-pendiente", solicitudAnualPendientes, "Pendientes");
      actualizarIndicador("desaprobado", "txt-rechazadas", solicitudAnualDesaprobadas, "Rechazadas");
    }, 2000);
    

    if(cargaSolicitudes !== ""){
        Swal.fire({
            icon: "success",
            title: "Solicitudes cargadas correctamente",
            text: cargaSolicitudes
        });
         aplicarFiltros();
    }else{
      Swal.fire({
            icon: "warning",
            title: "Ingrese un rango de fechas validos",
            text: cargaSolicitudes || "No se encontraron resultados"
        });
    }
  
  })

 

</script>

<!--Agregar estilos al span - estado de la tabla -->
<script>

  const estado = "pendiente";
  const indiceColumna = 9;
  const filas = document.querySelectorAll("#tablaDatos tr")

  filas.forEach((fila, index )=>{
      if(index === 0) return;

      const celda = fila.cells[indiceColumna];

      if (celda) {
      const span = celda.querySelector("span"); 
      if (span && span.textContent.trim() === "pendiente") {
        span.style.backgroundColor = "#f1da05";
        span.style.color = "black";
        span.style.padding = "7px"; 
        span.style.borderRadius = "8px"; 
      }
    }
      
  })
</script>
<!--Script para el boton de aprobar y desaprobar la solicitud GT-->
<script>

  document.getElementById("aprobarSolicitud").addEventListener("click",function(){
      const idSolicitud = document.getElementById("idSolicitud").textContent
      const estadoActual = document.getElementById("estadoSolicitud").textContent
      const estado = "aprobado" ;
      const respuestaEstado = "";

      if(estadoActual !== "pendiente"){
         Swal.fire({
                    icon: "warning",
                    title: "Modificaci√≥n no permitida",
                    text: "No puedes cambiar el estado de una solicitud ya gestionada",
                      })
                      return;
      }

      gestionarSolicitud(idSolicitud, estado , respuestaEstado)
  })

  document.getElementById("desaprobarSolicitud").addEventListener("click",function(){

    const modal = document.getElementById("modalDescripcion");
    const idSolicitud = document.getElementById("idSolicitud").textContent
    const estado = "desaprobado" 
    const respuesta = document.getElementById("respuesta").value.trim();
    const tipoSolicitud = document.getElementById("tipoSolicitud").textContent;
    const campoRespuesta = document.getElementById("campoRespuesta")
    const guardarRespuesta = document.getElementById("guardarRespuesta")
    let respuestaEstado = "";
    const estadoActual = document.getElementById("estadoSolicitud").textContent

     if(estadoActual !== "pendiente"){
         Swal.fire({
                    icon: "warning",
                    title: "Modificaci√≥n no permitida",
                    text: "No puedes cambiar el estado de una solicitud ya gestionada",
                      })
                      return;
      }

    if(tipoSolicitud === "PERMISO ACADEMICO"){
      if(respuesta === ""){
        
           Swal.fire({
                    icon: "warning",
                    title: "Indique motivo para desaprobar la solicitud",
                    text: "Las solicitudes academicas deben tener motivo para ser rechazadas",
                      })

        guardarRespuesta.style.display = "none";
        campoRespuesta.style.display = "block";
      }else{
        respuestaEstado = respuesta;

       gestionarSolicitud(idSolicitud, estado , respuestaEstado) 
      document.getElementById("respuesta").value = "";
      }
    }else{
          Swal.fire({
            title: "¬øEstas seguro?",
            text: "Luego de desaprobar la solicitud no es posible revertir esto",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Si, estoy seguro"
    }).then((result) => {
      if (result.isConfirmed) {
           gestionarSolicitud(idSolicitud, estado, respuestaEstado)
        
      }
    });
     
    }
    
    
  })

  function gestionarSolicitud(idSolicitud, estado, respuestaEstado){
        
        fetch("{% url 'gestionarSolicitudeGt' %}",{
          method: "POST",
          headers:{"Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken")},
          body: JSON.stringify({
            "idSolicitud": idSolicitud,
            "estadoSolicitud": estado,
            "respuestaEstado": respuestaEstado
          })
          })
          .then(response => response.json())
          .then(data => {
            if(data.success){
              const modal = document.getElementById("modalDescripcion");
              modal.classList.remove("show");
              Swal.fire({
                    icon: "success",
                    title: "Solicitud gestionada",
                    text: data.message,
                      }).then(()=>{
                        removeRowBySolicitudId(idSolicitud);
                      })

            }else{
              Swal.fire({
                    icon: "error",
                    title: "OOps courrio un error al aprobar la solicitud",
                    text: data.message,
                      }).then(()=>{
                        window.location.reload();
                      })
            }
          })
        }
</script>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const btn = document.getElementById('btnVerAdjunto');
  btn?.addEventListener('click', abrirVisorDesdeSolicitud);
  // Cerrar con click afuera
  document.getElementById('modalVisorArchivo').addEventListener('click', (e) => {
    if (e.target.id === 'modalVisorArchivo') cerrarModalVisor();
  });
  // Cerrar con ESC
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') cerrarModalVisor(); });
});

async function abrirVisorDesdeSolicitud() {

  const id = document.getElementById('idSolicitud')?.textContent.trim();
  if (!id) { alert('No hay idSolicitud en el modal.'); return; }

  
  const base = "{% url 'get_archivosgt' %}";
  const urlApi = `${base}?idSolicitud=${encodeURIComponent(id)}`;

  try {
    const res = await fetch(urlApi, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { success, url, tipoArchivo } = await res.json();
    if (!success || !url) { 
      const modal = document.getElementById("modalDescripcion");
      modal.classList.remove("show"); 
        Swal.fire({
            icon: "error",
            title: "No hay archivos cargados",
        })
    }

    abrirModalVisor(url,tipoArchivo);
  } catch (err) {
    console.error(err);
      Swal.fire({
            icon: "error",
            title: "No hay archivos cargados",
        })
  }
}

function abrirModalVisor(fileUrl, tipoArchivo) {
  
  const visor = document.getElementById('modalVisorArchivo');
  const link = document.getElementById('visorLink');
  const body = document.getElementById('visorBody');
  const IMG_EXT_RE = /^\.(?:avif|webp|png|gif|jpe?g|jfif|pjpeg|pjp|bmp|svg|ico|cur)$/i;

  link.href = fileUrl;
  body.innerHTML = ''; // limpia

  // Intento de mostrar: si termina en .pdf, iframe; si es imagen, <img>;
  // si no tiene extensi√≥n, probamos imagen y si falla, iframe.
  const lower = fileUrl.toLowerCase();

  if (tipoArchivo === ".pdf") {
    body.innerHTML = `<iframe src="${fileUrl}" width="100%" height="600px" style="border:none;"></iframe>`;
  } else if (IMG_EXT_RE.test(tipoArchivo)) {
    body.innerHTML = `<img src="${fileUrl}" alt="archivo" style="max-width:100%; height:auto;">`;
  } else {
    body.innerHTML = `
      <img src="https://www.entresistemas.com/wp-content/uploads/Microsoft-Word-Logo-2048x2048.png" alt="" width="300px">
      <h1>‚û°Ô∏è Si es un archivo de Word (.docx) da click arriba para abrir en otra pesta√±a üòÑ</h1>
    `;
  }


  visor.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function cerrarModalVisor() {
  const visor = document.getElementById('modalVisorArchivo');
  visor.classList.remove('show');
  document.body.style.overflow = '';
  // opcional: limpiar contenido para liberar memoria
  document.getElementById('visorBody').innerHTML = '';
}
</script>

<!--Script para el modal de descripcion de la solicitud-->
 <script>
  function abrirModal(descripcion, nombre, codigo, tipoSolicitud, id, estado) {
    const modal = document.getElementById("modalDescripcion");
    document.getElementById("nombreEmpleado").innerText = nombre;
    document.getElementById("codigoEmpleado").innerText = codigo;
    document.getElementById("tipoSolicitud").innerText = tipoSolicitud;
    document.getElementById("idSolicitud").innerText = id;
    document.getElementById("estadoSolicitud").innerText = estado;
    document.getElementById("contenidoDescripcion").innerText = descripcion;
    modal.classList.add("show");
  }

  function cerrarModal() {
    document.getElementById("campoRespuesta").style.display  = "none";
    const modal = document.getElementById("modalDescripcion");
    modal.classList.remove("show");
    // Esperar la transici√≥n antes de ocultar del DOM
    setTimeout(() => {
      modal.style.display = "none";
    }, 300);
  }

  // Cierra si se hace clic fuera del contenido
  window.addEventListener('click', function (e) {
    const modal = document.getElementById("modalDescripcion");
    const content = modal.querySelector('.modal-content');
    if (e.target === modal) {
      cerrarModal();
    }
  });

  // Asegura display:block cuando se agrega clase show
  const observer = new MutationObserver(() => {
    const modal = document.getElementById("modalDescripcion");
    if (modal.classList.contains("show")) {
      modal.style.display = "block";
    }
  });
  observer.observe(document.getElementById("modalDescripcion"), { attributes: true });

    document.getElementById("respuestaSolicitud").addEventListener("click",function(){
    campoRespuesta = document.getElementById("campoRespuesta")

    if (campoRespuesta.style.display === "none" || campoRespuesta.style.display === "" ){
      campoRespuesta.style.display = "block";
    }else{
      campoRespuesta.style.display = "none";
    }
  })

  document.getElementById("guardarRespuesta").addEventListener("click",function(){

    const respuesta = document.getElementById("respuesta").value
    const idSolicitudGt = document.getElementById("idSolicitud").textContent
    const modal = document.getElementById("modalDescripcion");

    if(respuesta !== ""){
      fetch("{% url 'insertarRespuesta' %}",{
      method: "POST",
      headers:{"Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken")},
      body: JSON.stringify({
        "idSolicitudGt": idSolicitudGt,
        "respuesta": respuesta,
      })
    })
    .then(response => response.json())
    .then(data => {
      if(data.success){
        Swal.fire({
            icon: "success",
            title: "Se envio correctamente la respuesta",
            text: `Id solicitud:${idSolicitudGt}, respuesta: ${respuesta}`
        }); 
        document.getElementById("respuesta").value = "";
        
              modal.classList.remove("show");
      }else{
        
        Swal.fire({
            icon: "error",
            title: "Se detectaron un error al enviar la respuesta",


          
        });
      }
    })
    }else{
      cerrarModal();
      Swal.fire({
            icon: "error",
            title: "Se detectaron campos vacios",
          
        });
    }
    

  })

</script>

<!--Script filtros-->
<script>
  // Acorde√≥n toggle
    document.querySelectorAll('.accordion-header').forEach(hdr => {
      hdr.addEventListener('click', () => {
        hdr.classList.toggle('active');
        const body = hdr.nextElementSibling;
        body.classList.toggle('active');
      });
    });


  // Elementos de filtro
  const filtros = {
    id: document.getElementById('filtroId'),
    nombre: document.getElementById('filtroNombre'),
    codigo: document.getElementById('filtroCodigo'),
    cargo: document.getElementById('filtroCargo'),
    tipoSolicitud : document.getElementById('filtroTipoSolicitud'),
    fechaInicial: document.getElementById('filtroFechaInicial'),
    fechaFinal: document.getElementById('filtroFechaFinal'),
    estado: document.getElementById('filtroEstadoSolicitud'),
  };

  // Asignar eventos
  Object.values(filtros).forEach(input => {
    input.addEventListener('input', aplicarFiltros);
    input.addEventListener('change', aplicarFiltros);
  });
function aplicarFiltros() {
  const valorId = filtros.id.value.toLowerCase().trim();
  const valorNombre = filtros.nombre.value.toLowerCase().trim();
  const valorCodigo = filtros.codigo.value.toLowerCase().trim();
  const valorCargo = filtros.cargo.value.toLowerCase().trim(); 
  const valorTipoSolicitud = filtros.tipoSolicitud.value.toLowerCase().trim();
  const valorFechaInicial = filtros.fechaInicial.value;
  const valorFechaFinal = filtros.fechaFinal.value;
  const valorEstado = filtros.estado.value;

  document.querySelectorAll('#tablaDatos tbody tr').forEach(row => {
    const tId = row.cells[1].textContent.toLowerCase().trim();
    const tNombre = row.cells[2].textContent.toLowerCase().trim();
    const tCodigo = row.cells[3].textContent.toLowerCase().trim();
    const tCargo = row.cells[4].textContent.toLowerCase().trim(); 
    const tTipoSolicitud = row.cells[5].textContent.toLowerCase().trim();
    const tFechaInicial = row.cells[7].textContent.trim();
    const tFechaFinal = row.cells[8].textContent.trim();
    const tEstado = row.cells[9].textContent.toLowerCase().trim();

    const coincideId = !valorId || tId === valorId;
    const coincideNombre = !valorNombre || tNombre.includes(valorNombre);
    const coincideCodigo = !valorCodigo || tCodigo === valorCodigo;
    const coincideCargo = !valorCargo || tCargo === valorCargo;
    const coincideSolicitud = !valorTipoSolicitud || tTipoSolicitud === valorTipoSolicitud;
    

    const fechaInicialFiltro = valorFechaInicial ? new Date(valorFechaInicial) : null;
    const fechaFinalFiltro = valorFechaFinal ? new Date(valorFechaFinal) : null;
    const fechaInicialDato = new Date(formatoFechaDMYaISO(tFechaInicial));
    const fechaFinalDato = new Date(formatoFechaDMYaISO(tFechaFinal));

    const coincideEstado = !valorEstado || tEstado === valorEstado;

    const coincideRangoFechas = (!fechaInicialFiltro || fechaInicialDato >= fechaInicialFiltro) &&
                                (!fechaFinalFiltro || fechaFinalDato <= fechaFinalFiltro);

    row.style.display = (coincideNombre && coincideCodigo && coincideCargo && coincideSolicitud && coincideRangoFechas && coincideEstado && coincideId) ? '' : 'none';
  });
}

function formatoFechaDMYaISO(fechaDMY) {
  const [dia, mes, anio] = fechaDMY.split('/');
  return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
}

</script>

<script>
document.addEventListener('click', e => {

  const btn = e.target.closest('.btn-ver-respuesta');
  if (!btn) return;
  const id = btn.dataset.id; 
  
  if(id === undefined){
    return;
  }

const cuerpoTabla = document.getElementById("mr-tbody");

 fetch(`{% url 'getRespuesta' %}?idSolicitudGt=${encodeURIComponent(id)}`, {
  method: 'GET',
  headers: { 'Accept': 'application/json' }
  })
  .then(response => response.json())
  .then(data =>{
    if (data.length == 0){
      cuerpoTabla.innerHTML = `<tr><td colspan="3"><span class="muted">Sin respuestas a√∫n.</span></td></tr>`;
      openModalRespuestas()
      return;
    }
    
    cuerpoTabla.innerHTML = data.map(r=>`
      <tr>
        <td>${safe(r.idSolicitud ?? '' )}</td>
        <td>${safe(r.respuesta ?? '')}</td>
        <td><div class="msg">${safe(r.fechaRespuesta ?? '')}</div></td>
      </tr>
    `).join('')
    
    openModalRespuestas()
  
  })

});

 function safe(s){ return String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#039;"); }
</script>

<!--Funcionalidad modal respuestas ADM-->
<script>
  function openModalRespuestas() {
    const m = document.getElementById('modal-respuestas');
    m.setAttribute('aria-hidden','false');
    // foco accesible
    requestAnimationFrame(() => m.querySelector('.modal-container').focus({preventScroll:true}));
    document.addEventListener('keydown', escCloseOnce);
  }

  function closeModalRespuestas() {
    const m = document.getElementById('modal-respuestas');
    m.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', escCloseOnce);
  }
  function escCloseOnce(e){ if(e.key === 'Escape') closeModalRespuestas(); }

  // Cerrar por botones / click fuera
  document.addEventListener('click', (e) => {
    if (e.target.matches('[data-modal-close]')) return closeModalRespuestas();
    const backdrop = e.target.closest('.modal-backdrop');
    if (backdrop && backdrop.getAttribute('aria-hidden') === 'false') {
      const container = backdrop.querySelector('.modal-container');
      if (!container.contains(e.target)) closeModalRespuestas();
    }
  });
</script>

<!--Funcionalidad modal informe de GT-Solicitudes-->
<script>
  document.getElementById("generarInformeGestion").addEventListener("click", function(){
  
    const modalFechas = document.getElementById("modalInformeGT");
    modalFechas.style.display = "block";
    setTimeout(() => {
    modalFechas.classList.add("mostrar");
  }, 10); 

  })

  function cerrarModalInformeGT() {
  const modal = document.getElementById("modalInformeGT");
  
  modal.classList.remove("mostrar");
  setTimeout(() => {
    modal.style.display = "none";
    document.getElementById("descargarInforme").innerText = "Descargar"
  }, 300); 
  
 
}


  document.getElementById("descargarInforme").addEventListener("click",function(){
   
    const fechaInicial = document.getElementById("fechaInicioGTX");
    const fechaFinal =  document.getElementById("fechaFinGTX");
    const opcionSeleccionada = document.getElementById("opcionEstado").value
    const opcionTipoSolicitud = document.getElementById("opcionTipoSolicitud").value

  if(!fechaInicial.value && !fechaFinal.value){
      Swal.fire({
            icon: "warning",
            title: "Campos vacios detectados",
            text: `Datos ingresados, fecha inicial: ${fechaInicial.value}, fecha final: ${fechaFinal.value}`
          
        });
        return;
  }

    const fechaInicialFormateada = fechaInicial.value.replaceAll("-","/")
    const fechaFinalFormateada = fechaFinal.value.replaceAll("-","/")

    /* alert(`Fecha inicial ${fechaInicialFormateada} fecha final: ${fechaFinalFormateada}, estado: ${opcionSeleccionada}`) */
     const params = new URLSearchParams({
      fechaInicialFormateada,    
      fechaFinalFormateada,             
      opcionSeleccionada,
      opcionTipoSolicitud
  });
  
  if(fechaInicialFormateada !== "" && fechaFinalFormateada !== "" && opcionSeleccionada !== ""){
      const url = `{% url 'descargarInformeGt' %}?${params.toString()}`;
      descargarExcel(url);

  }else{
     Swal.fire({
            icon: "error",
            title: "Se detectaron campos vacios",
            text: "Todos los campos son obligatorios"
          
        });
  }  
    
  })

  async function descargarExcel(url) {
  const res = await fetch(url, {
    method: 'GET',
  });

  if (!res.ok) {
    const msg = await res.text().catch(()=>'');
    throw new Error(`Error ${res.status}: ${msg}`);
  }else{
    const btn = document.getElementById("descargarInforme");
    btn.innerText = "Descargado correctamente";
    btn.classList.add('enviado');
  }

  const cd = res.headers.get('Content-Disposition') || '';
  const match = cd.match(/filename\*=UTF-8''([^;]+)|filename="([^"]+)"/);
  const filename = decodeURIComponent(match?.[1] || match?.[2] || 'reporte.xlsx');

  const blob = await res.blob();
  const urlBlob = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = urlBlob;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(urlBlob);
}

</script>

<script>

  document.getElementById("generarDashboard").addEventListener("click", function(){
    const modalDasboard = document.getElementById("modalDashboard")
    modalDasboard.style.display = "block";
    setTimeout(() => {
    modalDasboard.classList.add("mostrar");
  }, 10); 
  })

  function cerrarModalDashboard() {
  const modalDasboard = document.getElementById("modalDashboard");
  modalDasboard.classList.remove("mostrar");
  setTimeout(() => {
    modalDasboard.style.display = "none";
    document.getElementById("cargarDashboard").innerText = "Generar";

  }, 300); 
}

document.getElementById("cargarDashboard").addEventListener("click", function(){
  
  const fechaInicial = document.getElementById("fechaInicioDash");
  const fechaFinal = document.getElementById("fechaFinDash");
  const peticion = document.getElementById("opcionEstadoDash").value;

  if(!fechaInicial.value && !fechaFinal.value){
      Swal.fire({
            icon: "warning",
            title: "Se detectaron campos vacios",
            text: `Datos ingresados, fecha inicial: ${fechaInicial.value} , fecha final: ${fechaFinal.value} , petici√≥n: ${peticion}`
          
        });
        return;
  }

  const fechaInicialFormateada = fechaInicial.value.replaceAll("/","-");
  const fechaFinalFormateada = fechaFinal.value.replaceAll("/","-");

  const parametros = new URLSearchParams({
    fechaInicialFormateada,
    fechaFinalFormateada,
    peticion
    }
  )


  const url = `{% url 'vista_dashboard' %}?${parametros.toString()}`
  fetch(url,{
    "method": "GET"
  }).then(response => {
    if(response.ok){
      const btn = document.getElementById("cargarDashboard")
      btn.innerText = "Construyendo dashboard...";
      btn.classList.add('enviado');
      setTimeout(()=>{
          window.open(url, '_blank')}, 2000)
      
    }
  })

})

  document.getElementById("btnBuscarSolicitud").addEventListener("click",function(){

    const modalSolicitudGt =  document.getElementById("modalBuscarSolicitud")
    modalSolicitudGt.style.display = "block";
     setTimeout(() => {
    modalSolicitudGt.classList.add("mostrar");
  }, 10);

  })

  function cerrarModalBuscarSolicitud() {
  const modalSolicitudGt = document.getElementById("modalBuscarSolicitud");
  modalSolicitudGt.classList.remove("mostrar");
  setTimeout(() => {
    modalSolicitudGt.style.display = "none";
  }, 300); // coincide con el tiempo de transition
}

document.getElementById('btnCargarSolicitud').addEventListener("click", function(){
  const codigo = document.getElementById("buscarCodigoSolicitud").value
  const id = document.getElementById("buscarIdSolicitud").value

  if(codigo === "" && id === ""){
    
     Swal.fire({
            icon: "error",
            title: "Se detectaron codigo e id vacios",
            text: "Debes ingresar √≥ un codigo √≥ un  id valido"
          
        });
  }else{
      
  }

})
</script>

<script>
// Quita la fila cuyo ID (columna 2) coincide
function removeRowBySolicitudId(id) {
  id = String(id);
  const rows = document.querySelectorAll('#tablaDatos tbody tr');
  for (const tr of rows) {
    const cellId = tr.cells?.[1]?.textContent?.trim();
    if (cellId === id) {
      tr.classList.add('fade-out');
      setTimeout(() => {
        tr.remove();
        aplicarFiltros();            // recalcula visibilidad/empty state
        actualizarIndicadoresLocal(); // ajusta contadores mostrados
      }, 250);
      break;
    }
  }
}

// Ajusta los indicadores de ‚Äútotal / pendientes / aprobadas / rechazadas‚Äù en la UI
function actualizarIndicadoresLocal() {
  // Lee los visibles actuales
  const visibles = [...document.querySelectorAll('#tablaDatos tbody tr')]
    .filter(tr => tr.style.display !== 'none');

  // Si quieres solo ‚Äúpendientes‚Äù visibles, puedes contarlos por estado:
  const counts = { total: visibles.length, pendiente: 0, aprobado: 0, desaprobado: 0 };
  visibles.forEach(tr => {
    const estado = tr.cells?.[9]?.textContent?.trim()?.toLowerCase();
    if (estado && counts.hasOwnProperty(estado)) counts[estado]++;
  });

  // Actualiza tarjetas (ya tienes actualizarIndicador)
  actualizarIndicador("total", "txt-total", counts.total, "Solicitudes");
  actualizarIndicador("pendiente", "txt-pendiente", counts.pendiente, "Pendientes");
  actualizarIndicador("aprobado", "txt-aprobadas", counts.aprobado, "Aprobadas");
  actualizarIndicador("desaprobado", "txt-rechazadas", counts.desaprobado, "Rechazadas");
}
</script>


{% endblock %}